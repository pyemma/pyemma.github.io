<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Yang Pei</title>
    <description>The effort a coding monkey paid when he managed to become a coding machine.</description>
    <link>https://pyemma.github.io</link>
    <atom:link href="https://pyemma.github.io/feed.xml" rel="self" type="application/rss+xml" />
    
      <item>
        <title>æŠ•èµ„å°ç™½è¯»ã€ŠæŒ‡æ•°åŸºé‡‘æŠ•èµ„æŒ‡å—ã€‹</title>
        <description>&lt;p&gt;åœ¨ä¸Šä¸€ç¯‡&lt;a href=&quot;https://pyemma.github.io/Newbee-Reading-Investment-Books-I/&quot;&gt;blog&lt;/a&gt;ä¸­ï¼Œæˆ‘ä»¬å¤šæ¬¡æåˆ°äº†æŒ‡æ•°åŸºé‡‘çš„å®šæŠ•æ˜¯ä¸€ä¸ªå¯¹äºæŠ•èµ„æ–°æ‰‹æ¥è¯´éå¸¸ä¸é”™çš„æ–¹æ³•ã€‚ä¸ºæ­¤ï¼Œæˆ‘å»ä¸“é—¨æ‰¾äº†ä¸€æœ¬è®²è§£æŒ‡æ•°åŸºé‡‘æŠ•èµ„çš„ä¹¦ï¼šã€ŠæŒ‡æ•°åŸºé‡‘æŠ•èµ„æŒ‡å—ã€‹ã€‚è¿™æœ¬ä¹¦æ¯”è¾ƒå¸å¼•æˆ‘çš„ä¸¤ä¸ªç« èŠ‚åˆ†åˆ«æ˜¯å¦‚ä½•é€‰æ‹©æŒ‡æ•°åŸºé‡‘ï¼Œä»¥åŠå¦‚ä½•é€‰æ‹©å®šæŠ•çš„ç­–ç•¥ã€‚åœ¨è¿™ç¯‡blogä¸­ï¼Œæˆ‘ä¼šæ€»ç»“ä¸€äº›ä¹¦ä¸­æåˆ°çš„ä¸€äº›æ–¹æ³•å’Œå¤§å®¶åˆ†äº«ã€‚&lt;/p&gt;

&lt;p&gt;è¿™ç¯‡blogä»…ä»£è¡¨æˆ‘ä¸ªäººè§‚ç‚¹ï¼Œä¸æ„æˆä»»ä½•å…·ä½“çš„æŠ•èµ„å»ºè®®ï¼Œç‰¹æ­¤å£°æ˜ã€‚&lt;/p&gt;

&lt;h2 id=&quot;æŒ‡æ•°åŸºé‡‘çš„é€‰æ‹©æ–¹æ³•&quot;&gt;æŒ‡æ•°åŸºé‡‘çš„é€‰æ‹©æ–¹æ³•&lt;/h2&gt;

&lt;h3 id=&quot;é“å¬é€”è¯´æ³•ç¬‘&quot;&gt;é“å¬é€”è¯´æ³•ï¼ˆç¬‘ï¼‰&lt;/h3&gt;
&lt;p&gt;è¿™ä¸ªæ–¹æ³•æ˜¯æˆ‘ä¹‹å‰è‡ªå·±ç”¨çš„æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯ä»ç½‘ä¸Šçš„ä¸€äº›æ¨èè‚¡ç¥¨çš„åšä¸»ï¼Œæˆ–è€…æŠ•èµ„çš„è®ºå›çš„å¸–å­æ¥æŒ‘é€‰è¦æŠ•èµ„çš„ETFã€‚è¿™ä¸ªæ–¹æ³•æ²¡æœ‰ä»»ä½•çš„æŠ€æœ¯å«é‡ï¼Œè€Œä¸”æœ‰è¢«å¿½æ‚ çš„é£é™©ï¼Œè°¨æ…é€‰æ‹©ã€‚ä¸è¿‡å¦‚æœæ˜¯è§„æ¨¡æ¯”è¾ƒå¤§çš„ETFçš„è¯ï¼Œå…¶å®è¿˜æ˜¯ç›¸å¯¹æ¯”è¾ƒé è°±ã€‚æˆ‘ç°åœ¨è‡ªå·±ä¸€ç›´åœ¨åšæŒå®šæŠ•çš„VOOå°±æ˜¯é€šè¿‡è¿™ç§æ–¹æ³•äº†è§£åˆ°çš„ã€‚&lt;/p&gt;

&lt;h3 id=&quot;ç›ˆåˆ©æ”¶ç›Šç‡æ³•&quot;&gt;ç›ˆåˆ©æ”¶ç›Šç‡æ³•&lt;/h3&gt;
&lt;p&gt;æ‰€è°“çš„ç›ˆåˆ©æ”¶ç›Šç‡ï¼Œå…¶å®æŒ‡çš„å°±æ˜¯å¸‚ç›ˆç‡ï¼ˆPEï¼‰çš„å€’æ•°ã€‚å®ƒæ‰€ä»£è¡¨çš„æ„ä¹‰å°±æ˜¯è¯´ï¼Œå¦‚æœæˆ‘ä»¬ä¹°ä¸‹æ•´ä¸ªå…¬å¸çš„è¯ï¼Œè¿™å®¶å…¬å¸ä¸€å¹´çš„ç›ˆåˆ©èƒ½å¤Ÿå¸¦ç»™æˆ‘ä»¬çš„æ”¶ç›Šç‡ã€‚è€Œæ‰€è°“çš„ç›ˆåˆ©æ”¶ç›Šç‡æ³•ï¼Œå…¶å®å°±æ˜¯åœ¨ç›ˆåˆ©æ”¶ç›Šç‡é«˜çš„æ—¶å€™å‡ºæ‰‹ï¼Œä¹°å…¥ETFï¼›è€Œåœ¨ç›ˆåˆ©æ”¶ç›Šç‡ä½çš„æ—¶å€™å–å‡ºã€‚ä¹¦ä¸­ç»™å‡ºçš„å…·ä½“çš„å‚æ•°æ˜¯è¿™æ ·çš„ï¼š&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;å½“ç›ˆåˆ©æ”¶ç›Šç‡é«˜äº10%çš„æ—¶å€™ï¼Œåˆ†æ‰¹æŠ•èµ„&lt;/li&gt;
  &lt;li&gt;å½“ç›ˆåˆ©æ”¶ç›Šç‡ä½äº10%ä½†æ˜¯é«˜äº6.4%çš„æ—¶å€™ï¼ŒæŒæœ‰&lt;/li&gt;
  &lt;li&gt;å½“ç›ˆåˆ©æ”¶ç›Šç‡ä½äº6.4%çš„æ—¶å€™ï¼Œå–å‡º
ç›ˆåˆ©æ”¶ç›Šç‡æ³•æœ‰å…¶ä¸€å®šçš„å±€é™æ€§ï¼Œåªé€‚ç”¨äºæµé€šæ€§æ¯”è¾ƒå¥½ï¼Œç›ˆåˆ©æ¯”è¾ƒç¨³å®šçš„å“ç§ã€‚&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;em&gt;åŒæ—¶ï¼Œä¹¦ä¸­ç»™å‡ºçš„10%ä»¥åŠ6.4%çš„é˜ˆå€¼åŒºé—´ï¼Œä¸»è¦æ˜¯é’ˆå¯¹Aè‚¡çš„ã€‚è¿™ä¸ªæ•°å€¼ä¸ä¸€å®šé€‚ç”¨äºç¾è‚¡ã€‚å¦‚æœæœ‰å“ªä½å¤§ç¥çŸ¥é“é€‚ç”¨äºç¾è‚¡çš„é˜ˆå€¼çš„è¯ï¼Œæ¬¢è¿è¯„è®ºï¼&lt;/em&gt;&lt;/p&gt;

&lt;h3 id=&quot;åšæ ¼å…¬å¼æ³•&quot;&gt;åšæ ¼å…¬å¼æ³•&lt;/h3&gt;
&lt;p&gt;åšæ ¼å…¬å¼æ³•ï¼Œæ˜¯æŒ‡æ•°åŸºé‡‘ä¹‹çˆ¶çº¦ç¿°åšæ ¼æ‰€æå‡ºæ¥çš„ã€‚æ˜¯é’ˆå¯¹èƒ½å¤Ÿå½±å“è‚¡å¸‚é•¿æœŸå›æŠ¥ç‡çš„å‡ ä¸ªå…³é”®å› ç´ æ‰€æ€»ç»“å‡ºçš„ä¸€ç§æ–¹æ³•ã€‚ä»–æå‡ºäº†æŒ‡æ•°åŸºé‡‘çš„æ”¶ç›Šå…¬å¼ä¸º&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;æŒ‡æ•°åŸºé‡‘æœªæ¥çš„å¹´å¤åˆæ”¶ç›Šç‡ï¼Œç­‰äºæŒ‡æ•°åŸºé‡‘çš„æŠ•èµ„åˆæœŸè‚¡æ¯ç‡ï¼ŒåŠ ä¸ŠæŒ‡æ•°åŸºé‡‘æ¯å¹´çš„å¸‚ç›ˆç‡å˜åŒ–ç‡ï¼Œå†åŠ ä¸ŠæŒ‡æ•°åŸºé‡‘æ¯å¹´çš„ç›ˆåˆ©å˜åŒ–ç‡&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;ç„¶è€Œï¼Œè¿™ä¸ªå…¬å¼çš„å®é™…è®¡ç®—è¿˜æ˜¯å¾ˆå¤æ‚çš„ï¼ˆè¿™ä¸ªä¸‹é¢çš„ä¾‹å­å¯ä»¥çœ‹å‡ºæ¥ï¼‰ï¼Œä½†æ˜¯æ ¹æ®è¿™ä¸ªå…¬å¼ä¸­æ‰€åŒ…å«çš„å˜é‡ï¼Œæˆ‘ä»¬å…¶å®å¯ä»¥å¾—åˆ°ä¸€äº›ç®€å•çš„æ­¥éª¤æ¥æ“ä½œ&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;åœ¨è‚¡æ¯ç‡é«˜çš„æ—¶å€™ä¹°å…¥&lt;/li&gt;
  &lt;li&gt;åœ¨å¸‚ç›ˆç‡å¤„äºå†å²è¾ƒä½ä½ç½®çš„æ—¶å€™ä¹°å…¥&lt;/li&gt;
  &lt;li&gt;ä¹°å…¥ä¹‹åï¼Œç­‰å¾…å¸‚ç›ˆç‡ä»ä½åˆ°é«˜&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;ä¸¾ä¸ª&quot;&gt;ä¸¾ä¸ªğŸŒ°&lt;/h3&gt;
&lt;p&gt;ä¸‹é¢æˆ‘ä»¬å°±ç”¨VOOè¿™ä¸ªETFä½œä¸ºä¾‹å­ï¼Œæ¥è¿ç”¨ä¸€ä¸‹ä¸Šé¢çš„ä¸¤ä¸ªæ–¹æ³•ã€‚
PS: æ•°æ®çš„æˆªå–æ—¶é—´ç‚¹æ˜¯5/31/2021&lt;/p&gt;

&lt;p&gt;æˆ‘ä»¬å¯ä»¥ä»Vanguardçš„&lt;a href=&quot;https://institutional.vanguard.com/web/c1/investments/product-details/fund/0968&quot;&gt;å®˜ç½‘&lt;/a&gt;ä¸Šæ‰¾åˆ°VOOçš„ä¸€äº›æ•°æ®ï¼ˆå®˜ç½‘ç›¸æ¯”è¾ƒå…¶ä»–çš„é‡é¸¡ç½‘ç«™æ¥è¯´æ•°æ®æºæ›´åŠ é è°±ï¼Œæˆ‘ä¸ªäººè§‰å¾—ï¼‰ã€‚ä»è¿™ä¸Šé¢çœ‹ï¼ŒVOOè¿™ä¸ªETFç°åœ¨çš„PEå€¼å¤§æ¦‚æ˜¯26.3ï¼Œé‚£ä¹ˆå…¶ç›ˆåˆ©æ”¶ç›Šç‡å¤§æ¦‚ä¸º3.80%ã€‚æ ¹æ®ç›ˆåˆ©æ”¶ç›Šç‡æ³•ï¼Œæˆ‘ä»¬åº”è¯¥é€‰æ‹©å–å‡ºVOOã€‚&lt;/p&gt;

&lt;p&gt;ç„¶åæˆ‘ä»¬å¯ä»¥å†æ ¹æ®åšæ ¼å…¬å¼æ³•æ¥ç®—ç®—çœ‹VOOçš„æœªæ¥å¹´å¤åˆæ”¶ç›Šç‡ã€‚ä¸ºäº†è®¡ç®—è¿™ä¸ªï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“è‚¡æ¯ç‡ï¼Œå¸‚ç›ˆç‡å˜åŒ–ç‡ä»¥åŠç›ˆåˆ©å˜åŒ–ç‡ã€‚&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;è‚¡æ¯ç‡åœ¨äº”å¹´å‰çš„æ—¶å€™æ˜¯2.23% &lt;a href=&quot;http://www.lazyportfolioetf.com/etf/vanguard-sp-500-voo-dividend-yield/&quot;&gt;æ•°æ®æ¥æº&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;å¸‚ç›ˆç‡å˜åŒ–ç‡åœ¨è¿‡å»äº”å¹´ä¸­ä»5.65%å˜åŒ–åˆ°äº†ç°åœ¨çš„3.80%, é‚£ä¹ˆå¹´å¹³å‡å˜åŒ–ç‡ä¸º-7.6%å·¦å³ã€‚ï¼ˆè¿™ä¸ªæ•°å­—åœ¨å®˜ç½‘ä¸Šæ‰¾ä¸åˆ°ï¼Œè€Œä¸”å®˜ç½‘ä¸Šä¹Ÿæ²¡æœ‰æä¾›historicalçš„PEçš„æ•°æ®ï¼Œæ‰€ä»¥æˆ‘ç”¨äº†è¿™ä¸ª&lt;a href=&quot;https://www.gurufocus.com/etf/VOO&quot;&gt;èµ„æº&lt;/a&gt;ä¸Šçš„æ•°æ®&lt;/li&gt;
  &lt;li&gt;ç›ˆåˆ©å˜åŒ–ç‡ï¼Œåœ¨å®˜ç½‘ä¸Šèƒ½ä¸ªå¾—åˆ°ï¼Œåœ¨è¿‡å»äº”å¹´ä¸­è¿™ä¸ªæ•°å€¼ä¸º18.9%&lt;/li&gt;
  &lt;li&gt;å°†ä¸Šé¢çš„æ•°æ®ç»“åˆèµ·æ¥ï¼Œæˆ‘ä»¬èƒ½å¾—åˆ°18.9 - 7.6 + 2.23 = 13.53%ï¼Œè¿™ä¸ªä¸å®˜ç½‘ä¸Šå®é™…ç»™å‡ºçš„äº”å¹´å¹³å‡æ”¶ç›Š13.87%ç›¸å·®ä¸å¤š&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;æˆ‘ä»¬å¯ä»¥æ¯”è¾ƒVanguardæ——ä¸‹çš„å¦å¤–ä¸€ä¸ªETF VCRã€‚è¿™ä¸ªæ˜¯è¿½è¸ªå¿…é¡»éå¿…é¡»æ¶ˆè´¹å“æŒ‡æ•°çš„ä¸€ä¸ªETFã€‚å…·ä½“çš„è®¡ç®—ç»“æœå¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;è‚¡æ¯ç‡åœ¨äº”å¹´å‰çš„æ—¶å€™æ˜¯1.63% &lt;a href=&quot;https://seekingalpha.com/symbol/VCR/dividends/yield&quot;&gt;æ•°æ®æ¥æº&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;å¸‚ç›ˆç‡å˜åŒ–ç‡åœ¨è¿‡å»çš„äº”å¹´ä¸­ä»3.34%å˜åŒ–åˆ°äº†ç°åœ¨çš„3.12ï¼Œå¹³å‡å˜åŒ–ç‡ä¸º-9.9å·¦å³ã€‚&lt;/li&gt;
  &lt;li&gt;ç›ˆåˆ©å˜åŒ–ç‡ï¼Œåœ¨è¿‡å»äº”å¹´ä¸­æ•°å€¼ä¸º33.6%&lt;/li&gt;
  &lt;li&gt;å¸¦å…¥å…¬å¼æˆ‘ä»¬èƒ½å¤Ÿå¾—åˆ° 33.6 - 9.9 + 1.63 = 25.33%&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;ç”±æ­¤å¯è§ï¼ŒVCRç›¸æ¯”è¾ƒVOOè€Œè¨€ï¼Œåœ¨åšæ ¼å…¬å¼æ³•ä¸­æ›´å¥½ï¼Œä½†æ˜¯åœ¨å¸‚ç›ˆç‡ä¸­åˆ™è¦ç›¸å¯¹å·®ä¸€äº›ã€‚é™¤æ­¤ä¹‹å¤–ï¼ŒVCRçš„ç®¡ç†è´¹ç”¨ä¸º0.1%ï¼Œè¿™ä¸ªæ¯”VOOçš„0.03%å¯æ˜¯è´µäº†3å€ï¼Œä¹Ÿæ˜¯ä¸å¯å°è§‘çš„ä¸€ç‚¹ã€‚è‡³äºå…·ä½“åº”è¯¥æŠ•èµ„VOOè¿˜æ˜¯VCRï¼Œè¿™ä¸ªå°±è¦é æŠ•èµ„äººè‡ªå·±çš„å–œå¥½æ¥å†³å®šäº†ã€‚&lt;/p&gt;

&lt;h2 id=&quot;æŒ‡æ•°åŸºé‡‘çš„å®šæŠ•æ–¹æ³•&quot;&gt;æŒ‡æ•°åŸºé‡‘çš„å®šæŠ•æ–¹æ³•&lt;/h2&gt;

&lt;h3 id=&quot;å®šæ—¶å®šé‡æ³•ç¬‘&quot;&gt;å®šæ—¶å®šé‡æ³•ï¼ˆç¬‘ï¼‰&lt;/h3&gt;
&lt;p&gt;è¿™ä¸ªæ˜¯æˆ‘è‡ªå·±ä¹‹å‰ä¸€ç›´åœ¨ç”¨çš„ä¸€ç§å‚»ç“œå¼æ–¹æ³•ã€‚å°±æ˜¯æ¯ä¸ªæœˆåœ¨å›ºå®šçš„æ—¶é—´ï¼ˆæ¯”å¦‚è¯´æ¯ä¸ªæœˆçš„ç¬¬ä¸€å¤©ï¼‰ï¼Œä¹°å…¥å›ºå®šè‚¡æ•°çš„ETFï¼ˆæ¯”å¦‚è¯´5è‚¡VOOï¼‰ã€‚è¿™ç§æ–¹æ³•è‡ªç„¶ä¸æ˜¯æœ€ä¼˜çš„ï¼Œä½†æ˜¯ç®€å•æ— è„‘ï¼Œçœå»å¾ˆå¤šéœ€è¦æ“å¿ƒçš„ä¸œè¥¿ã€‚å°‘æ‹¿ç‚¹æ”¶ç›Šï¼Œå¤šç©ºä½™ä¸€äº›æ—¶é—´å»å¹²ç‚¹åˆ«çš„äº‹æƒ…ï¼ˆæ¯”å¦‚è¯´ç©å„¿æ‰‹æ¸¸ï¼‰ã€‚&lt;/p&gt;

&lt;h3 id=&quot;å®šæ—¶å®šèµ„é‡‘&quot;&gt;å®šæ—¶å®šèµ„é‡‘&lt;/h3&gt;
&lt;p&gt;è¿™ä¸ªå’Œå®šæ—¶å®šé‡å·®ä¸å¤ªå¤šï¼Œåªæ˜¯æ¯æ¬¡å›ºå®šæŠ•å…¥çš„é‡‘é¢ï¼Œæ¯”å¦‚å›ºå®šä»å·¥èµ„å•ä¸­æ‰£é™¤2000ç¾é‡‘æŠ•å…¥åˆ°æŒ‡æ•°åŸºé‡‘ä¸­ã€‚æˆ‘æœ€è¿‘è¢«å®‰åˆ©ä½¿ç”¨äº†ä¸€æ¬¾æ™ºèƒ½å®šæŠ•çš„APP wealthfrontï¼Œåœ¨è¿™ä¸ªAPPä¸­æˆ‘å°±ä½¿ç”¨äº†è¿™ç§æ–¹æ³•ã€‚ç­‰å¹´åº•çš„æ—¶å€™æˆ‘å›æ¥é€šæŠ¥ä¸€ä¸‹å®é™…çš„æ”¶ç›Šå¦‚ä½•ã€‚&lt;/p&gt;

&lt;h3 id=&quot;ä¸å®šæ—¶ä¸å®šèµ„é‡‘ä»·æ ¼ä½äºä»·å€¼æ—¶å®šæŠ•&quot;&gt;ä¸å®šæ—¶ä¸å®šèµ„é‡‘ï¼ˆä»·æ ¼ä½äºä»·å€¼æ—¶å®šæŠ•ï¼‰&lt;/h3&gt;
&lt;p&gt;è¿™ä¸ªå°±æ˜¯ä¸€ä¸ªç›¸å¯¹é«˜ç«¯çš„æ–¹æ³•äº†ï¼Œä¹¦ä¸­ç»™å‡ºçš„å»ºè®®æ˜¯è¿™æ ·çš„&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;åœ¨ç›ˆåˆ©æ”¶ç›Šç‡å¤§äº10%çš„æ—¶å€™åšæŒå®šæŠ• ï¼ˆæˆ–è€…å¸‚ç›ˆç‡/å¸‚å‡€ç‡å¤„äºå†å²åº•éƒ¨åŒºåŸŸçš„æ—¶å€™&lt;/li&gt;
  &lt;li&gt;ç›ˆåˆ©æ”¶ç›Šç‡å°äº10%ä½†æ˜¯å¤§äº6.4%çš„æ—¶å€™ï¼Œæš‚åœå®šæŠ•ï¼Œç»§ç»­æŒæœ‰ï¼›å¯ä»¥å®šæŠ•å…¶ä»–ç›ˆåˆ©æ”¶ç›Šç‡å¤§äº10%çš„å“ç§ ï¼ˆæˆ–è€…å½“å¸‚ç›ˆç‡/å¸‚å‡€ç‡å›å½’æ­£å¸¸ä¼°å€¼&lt;/li&gt;
  &lt;li&gt;ç›ˆåˆ©æ”¶ç›Šç‡å°äº6.4%çš„æ—¶å€™å–å‡º ï¼ˆæˆ–è€…å½“å¸‚ç›ˆç‡/å¸‚å‡€ç‡å¤„äºå†å²é«˜ä½&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;è¿™ä¸ªæ–¹æ³•è›®éœ€è¦ç»éªŒï¼Œæ¥åˆ¤æ–­ç°åœ¨ETFçš„ä»·å€¼æ‰€å¤„åœ¨çš„åŒºé—´æ˜¯ä»€ä¹ˆæ ·å­çš„ã€‚æˆ‘æ‰“ç®—åœ¨æŠ•èµ„è¿™ä¸ªé¢†åŸŸå…ˆæ‘¸çˆ¬æ»šæ‰“ä¸€æ®µæ—¶é—´ä¹‹åå†è€ƒè™‘ä½¿ç”¨è¿™ç§é«˜ç«¯çš„æ–¹æ³•ã€‚&lt;/p&gt;
</description>
        <pubDate>Fri, 14 May 2021 00:00:00 -0700</pubDate>
        <link>https://pyemma.github.io//Newbee-Reading-Investment-Books-II/</link>
        <guid isPermaLink="true">https://pyemma.github.io//Newbee-Reading-Investment-Books-II/</guid>
      </item>
    
      <item>
        <title>æŠ•èµ„å°ç™½è¯»ã€Šèªæ˜çš„æŠ•èµ„è€…ã€‹/ ã€ŠæŠ•èµ„çš„å¸¸è¯†ã€‹</title>
        <description>&lt;p&gt;ä½œä¸ºä¸€ä¸ªæŠ•èµ„å°ç™½ï¼Œé˜…è¯»ä¸€äº›ä¹¦ç±æ¥å­¦ä¹ ä¸€äº›çŸ¥è¯†è¿˜æ˜¯å¾ˆæœ‰å¿…è¦çš„ã€‚åœ¨ç³ç…æ»¡ç›®çš„æŠ•èµ„ç±»ä¹¦ç±ä¸­ï¼Œæˆ‘ä¼˜å…ˆè¯»äº†è¿™ä¹ˆä¸¤æœ¬ä¹¦ï¼šã€Šèªæ˜çš„æŠ•èµ„è€…ã€‹å’Œã€ŠæŠ•èµ„çš„å¸¸è¯†ã€‹ã€‚ã€Šèªæ˜çš„æŠ•èµ„è€…ã€‹æ˜¯è¢«èª‰ä¸ºåå°”è¡—æ•™çˆ¶çš„æ ¼é›·å„å§†å†™çš„ä¸€æœ¬é€šä¿—æ˜“æ‡‚çš„é¢å‘å¤§ä¼—çš„æŠ•èµ„ä¹¦ç±ã€‚æ ¼è€æ˜¯ä»·å€¼æŠ•èµ„çš„å…ˆé©±ï¼Œå·´è²ç‰¹çš„ç²¾ç¥å¯¼å¸ˆï¼Œå…¶æŠ•èµ„ç†å¿µå¯è§ä¸€æ–‘ã€‚ã€ŠæŠ•èµ„çš„å¸¸è¯†ã€‹æ˜¯ä¸€æœ¬æ›´åŠ é€šä¿—æ˜“æ‡‚çš„å°ä¹¦ï¼Œä»¥æœ´å®æ— åçš„è¯­è¨€ï¼Œå‘å¤§ä¼—ä¼ æˆæŠ•èµ„çš„ç†å¿µã€‚è¿™æœ¬ä¹¦çš„ä¸¤ä½ä½œè€…ä¹Ÿæ˜¯åœ¨æŠ•èµ„é¢†åŸŸéå¸¸è‘—åçš„äººç‰©ã€‚åœ¨è¿™ç¯‡åšå®¢é‡Œé¢ï¼Œæˆ‘æ€»ç»“ä¸€äº›æˆ‘è‡ªå·±è¯»å®Œè¿™ä¸¤æœ¬ä¹¦ä¹‹åæ„Ÿè§¦æœ€æ·±åˆ»çš„ä¸€äº›éƒ¨åˆ†ï¼Œèµ·åˆ°ä¸€äº›æŠ›ç –å¼•ç‰çš„ä½œç”¨ï¼Œä¹Ÿå¸Œæœ›å¤§å®¶èƒ½æœ‰æ—¶é—´äº²è‡ªè¯»ä¸€è¯»è¿™ä¸¤æœ¬ç»å…¸çš„ä¹¦ç±ã€‚&lt;/p&gt;

&lt;h3 id=&quot;æŠ•èµ„çš„å¸¸è¯†&quot;&gt;ã€ŠæŠ•èµ„çš„å¸¸è¯†ã€‹&lt;/h3&gt;
&lt;p&gt;è¿™æœ¬ä¹¦éå¸¸çš„ç²¾è‡´ï¼Œä½œè€…ç”¨ç²¾ç®€çš„è¯­è¨€ï¼Œå‘å¹¿å¤§ä¸ªäººæŠ•èµ„è€…ï¼ˆä¿—ç§°çš„æ•£æˆ·ï¼‰ï¼Œæ¨èäº†ä¸€äº›æŠ•èµ„ç†å¿µï¼š&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;åŸºé‡‘å®šæŠ•ï¼šæ¯ä¸ªæœˆæ ¹æ®ä¸ªäººå·¥èµ„ç›ˆä½™çš„æƒ…å†µï¼Œå°†ç›ˆä½™æŒ‰ç…§å›ºå®šçš„é‡‘é¢æŠ•å…¥çš„åŸºé‡‘ä¹‹ä¸­ã€‚
    &lt;ul&gt;
      &lt;li&gt;ä½œè€…åœ¨è¿™é‡Œæåˆ°çš„æ˜¯åŸºé‡‘ï¼Œç°åœ¨çš„è¯æˆ‘ä»¬æœ‰å¦å¤–ä¸€ç§é€‰æ‹©ï¼Œä¹Ÿå°±æ˜¯ETFã€‚ç›¸æ¯”è¾ƒåŸºé‡‘æ¥è¯´ï¼Œä¹°å–èµ·æ¥æ›´åŠ çš„æ–¹ä¾¿ï¼Œè€Œä¸”ç°åœ¨å¤§éƒ¨åˆ†åˆ¸å•†éƒ½ä¸è¦æ‰‹ç»­è´¹äº†ï¼Œæ‰€ä»¥ä½œè€…åœ¨ä¹¦ä¸­æåˆ°çš„ETFçš„ä¸€ä¸ªçŸ­æ¿å…¶å®å·²ç»ä¸å­˜åœ¨äº†ã€‚&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;èµ„äº§å¤šå…ƒåŒ–ï¼šä¿—è¯æ‰€è¯´çš„ä¸è¦æŠŠé¸¡è›‹éƒ½æ”¾åœ¨ä¸€ä¸ªç¯®å­é‡Œé¢ï¼Œä¸“ä¸šç‚¹çš„è¯´æ³•å¥½åƒå«ç°ä»£èµ„äº§ç†è®ºã€‚å¤šå…ƒåŒ–å¯ä»¥ä»å„ä¸ªå±‚é¢ä¸Šæ¥è¿›è¡Œï¼Œæ¯”å¦‚ä»èµ„äº§çš„ç±»å‹é‡Œé¢ï¼Œæˆ‘ä»¬å¯ä»¥é…ç½®ä¸€ä¸ªåŒ…æ‹¬è‚¡ç¥¨ï¼Œå€ºåˆ¸è·Ÿæˆ¿åœ°äº§çš„æŠ•èµ„ç»„åˆï¼Œè¿™ä¸ªæ¯”çº¯ç²¹çš„è‚¡ç¥¨çš„è¦æ›´åŠ çš„ç¨³å®šï¼ˆå¯èƒ½ä¼šæŸå¤±ä¸€éƒ¨åˆ†çš„æ”¶ç›Šï¼‰ï¼›åœ¨è‚¡ç¥¨æŠ•èµ„é‡Œé¢ï¼Œæˆ‘ä»¬å¯ä»¥è´­ä¹°å¤šä¸ªæ¿å—çš„è‚¡ç¥¨ï¼Œè€Œä¸æ˜¯å…¨éƒ¨ç ¸å…¥ä¸€ä¸ªå…¬å¸çš„è‚¡ç¥¨ã€‚
    &lt;ul&gt;
      &lt;li&gt;å¤šå…ƒåŒ–ä¹Ÿå¯ä»¥ä»å¸‚åœºçš„ç»´åº¦æ¥è¿›è¡Œï¼Œæ¯”å¦‚ï¼Œæˆ‘ä»¬ä¸å•å•ä¹°ç¾è‚¡çš„å¤§ç›˜æŒ‡æ•°ï¼Œä¹Ÿå¯ä»¥ä¹°ä¸€ç‚¹æ–°å…´å¸‚åœºçš„å¤§ç›˜æŒ‡æ•°ï¼Œæˆ–è€…ä¸Šè¯50æŒ‡æ•°ä¹‹ç±»çš„ã€‚&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;èµ„äº§é…ç½®ï¼šæ—¢ç„¶æˆ‘ä»¬è¦åšèµ„äº§å¤šå…ƒåŒ–ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±éœ€è¦æ ¹æ®æˆ‘ä»¬è‡ªå·±æ‰€æœŸæœ›çš„æ”¶ç›Šä¸é£é™©ï¼Œç»™ä¸åŒçš„èµ„äº§åœ¨æ€»èµ„äº§ä¸­é…ç½®ä¸åŒçš„æ¯”ä¾‹ã€‚ç”±äºä¸åŒçš„èµ„äº§åœ¨ä¸åŒçš„ç»æµå‘¨æœŸä¸­ä¼šæœ‰ä¸åŒçš„è¡¨ç°ï¼Œè¿™ä¸ªæ¯”ä¾‹ä¼šå› æ­¤è€Œå‘ç”Ÿå˜åŒ–ã€‚æˆ‘ä»¬éœ€è¦åšçš„äº‹æƒ…å°±æ˜¯å®šæ—¶å¯¹èµ„äº§åšå‡ºè°ƒæ•´ï¼Œä»è€Œä½¿å…¶æ¯”ä¾‹ä¸æˆ‘ä»¬æœ€åˆæ‰€è§„åˆ’çš„æ¯”ä¾‹ä¸€è‡´ã€‚è¿™ä¸ªæ“ä½œä¸éœ€è¦éå¸¸çš„é¢‘ç¹ï¼ŒåŸºæœ¬ä¸Šæ¯åŠå¹´è°ƒæ•´ä¸€æ¬¡å°±å¯ä»¥äº†ã€‚&lt;/li&gt;
  &lt;li&gt;æŠ•èµ„æŒ‡æ•°åŒ–ï¼šå°±æ˜¯åªä¹°æŒ‡æ•°åŸºé‡‘æˆ–è€…è·Ÿè¸ªæŒ‡æ•°åŸºé‡‘çš„ETFï¼Œè€Œä¸æ˜¯è‡ªå·±é€‰æ‹©å…¬å¸çš„è‚¡ç¥¨ã€‚è¿™ä¸ªä¹Ÿæ˜¯å·´è²ç‰¹è€çˆ·å­å¯¹äºå¤§ä¼—æŠ•èµ„è€…æœ€æœ€å»ºè®®çš„æŠ•èµ„æ–¹å¼äº†ã€‚å…¶å¥¢æ±‚æˆ˜èƒœå¸‚åœºï¼Œè·å¾—å¸‚åœºçš„å¹³å‡æ”¶ç›Šï¼Œè·‘èµ¢é€šèƒ€ï¼Œè¿™ç§ç®€å•çš„ç­–ç•¥åè€Œèƒ½æˆ˜èƒœå¸‚åœºä¸Šçš„å¤§å¤šæ•°å‚ä¸è€…ã€‚
    &lt;ul&gt;
      &lt;li&gt;æˆ‘ä»¬ä¹Ÿå¯ä»¥å¯¹è¿™ä¸ªå»ºè®®åšä¸€å®šçš„è°ƒæ•´ï¼Œæ¯”å¦‚90%çš„èµ„äº§é…ç½®åœ¨æŒ‡æ•°åŸºé‡‘ï¼Œç”¨å‰©ä½™çš„10%æ¥è‡ªå·±æŒ‘é€‰è‚¡ç¥¨ã€‚è¿™æ ·æˆ‘ä»¬ä¸ä»…ä¸ç”¨æ‰¿å—å¤ªé«˜çš„é£é™©ï¼Œæ¯å¤©æ™šä¸Šç¡ä¸ªå®‰ç¨³è§‰ï¼Œä¹Ÿèƒ½äº«å—ä¸€ä¸‹æ™ºåŠ›æŒ‘æˆ˜çš„ä¹è¶£ã€‚&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;èªæ˜çš„æŠ•èµ„è€…&quot;&gt;ã€Šèªæ˜çš„æŠ•èµ„è€…ã€‹&lt;/h3&gt;
&lt;p&gt;è¿™æœ¬ä¹¦æˆ‘æ²¡æœ‰å…¨éƒ¨è¯»å®Œï¼Œè€Œæ˜¯é’ˆå¯¹æ€§çš„é˜…è¯»äº†å…¶ä¸­ä¸€äº›é’ˆå¯¹è¢«åŠ¨æŠ•èµ„è€…çš„ç« èŠ‚ã€‚åœ¨è¯»åˆ°çš„ç« èŠ‚é‡Œé¢ï¼Œæœ‰ä¸€äº›å¯¹æˆ‘å¾ˆæœ‰å¯å‘çš„å†…å®¹ï¼Œåœ¨è¿™é‡Œå’Œå¤§å®¶åˆ†äº«ä¸€ä¸‹ã€‚æ³¨æ„ï¼Œè¿™é‡Œçš„å†…å®¹æœ‰ä¸€éƒ¨åˆ†æ˜¯æ ¼è€çš„åŸè‘—ï¼Œå¦ä¸€éƒ¨åˆ†æ˜¯æœ¬ä¹¦çš„ä½œè€…çš„ç‚¹è¯„ã€‚&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;é’ˆå¯¹å¸‚åœºæ³¢åŠ¨ï¼Œæ ¼è€å»ºè®®ï¼šä¸è¦åœ¨è‚¡ä»·å‡ºç°å¤§å¹…ä¸Šæ¶¨åç«‹å³è´­ä¹°è‚¡ç¥¨ï¼Œä¹Ÿä¸è¦åœ¨è‚¡ä»·å‡ºç°å¤§å¹…ä¸‹è·Œåç«‹å³å‡ºå”®è‚¡ç¥¨ã€‚è¿½æ¶¨æ€è·Œï¼Œåªèƒ½å½“ä¸€é¢—è¢«å‰²çš„éŸ­èœã€‚å…¶å®è¿™æ¡å»ºè®®å°±æ˜¯å‘Šè¯‰æˆ‘ä»¬è¦ç›¸ä¿¡è‡ªå·±çš„åˆ¤æ–­ï¼Œä¸è¦è¢«å¸‚åœºä¸Šçš„å™ªéŸ³æ‰€å¹²æ‰°ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæ ¼è€å»ºè®®æˆ‘ä»¬èµ°ç¨‹å¼åŒ–çš„æŠ•èµ„ç­–ç•¥ï¼Œå› ä¸ºè¿™æ ·æ¯”è¾ƒå®¹æ˜“ç®¡ä½æˆ‘ä»¬è‡ªå·±çš„æ‰‹ã€‚æŠ•èµ„æœ€å¤§çš„æ•Œäººï¼Œæ°¸è¿œéƒ½æ˜¯æˆ‘ä»¬è‡ªå·±ã€‚ä½œè€…åœ¨ç‚¹è¯„ä¸­ä¹Ÿå¦‚æ­¤è¯´é“ï¼šæŠ•èµ„æ´»åŠ¨å¹¶éè¦åœ¨æ¸¸æˆä¸­æ‰“è´¥åˆ«äººï¼Œè€Œæ˜¯è¦åœ¨æ¸¸æˆä¸­ç®¡å¥½è‡ªå·±ã€‚&lt;/li&gt;
  &lt;li&gt;é’ˆå¯¹æ™®é€šè‚¡çš„åˆ†æï¼Œæœ‰ä»¥ä¸‹çš„å‡ ä¸ªå¤§æ–¹é¢
    &lt;ul&gt;
      &lt;li&gt;æ€»ä½“çš„é•¿æœŸå‰æ™¯ï¼Œæ¥çœ‹çœ‹è¿™ä¸ªè¡Œä¸šæ˜¯ä¸æ˜¯å¤•é˜³äº§ä¸š
        &lt;ul&gt;
          &lt;li&gt;ä¼ä¸šå¢é•¿çš„åŸå› æ˜¯ä»€ä¹ˆï¼Œä¼ä¸šç°åœ¨ï¼ˆå°†æ¥ï¼‰çš„åˆ©æ¶¦æ¥è‡ªä½•æ–¹ï¼Ÿè¿™ä¸ªå’Œã€Šå¾è¿œçš„æŠ•èµ„è¯¾ã€‹é‡Œé¢åˆ†æ2Cè¡Œä¸šï¼Œäº’è”ç½‘è¡Œä¸šçš„å‘å±•çš„åº•å±‚é€»è¾‘å¾ˆç±»ä¼¼&lt;/li&gt;
          &lt;li&gt;ä¼ä¸šæ˜¯å¦æœ‰è¶³å¤Ÿçš„æŠ¤åŸæ²³ï¼Œæ¯”å¦‚å“ç‰Œå½¢è±¡ï¼Œå¯¹å¸‚åœºçš„å„æ–­æˆ–è€…å‡ ä¹å„æ–­ï¼Œæ— å½¢èµ„äº§ï¼Œæ— æ³•è¢«æ›¿ä»£ç­‰&lt;/li&gt;
          &lt;li&gt;ç¨³å®šä¸”æŒç»­çš„å¢é•¿ç‡ï¼ˆå¾ˆé«˜çš„å¢é•¿ç‡æ˜¯ä¸å¯èƒ½ä¸€ç›´ç»´æŒçš„ï¼‰&lt;/li&gt;
          &lt;li&gt;å¯¹R&amp;amp;Dçš„ç ”å‘æŠ•å…¥ç¨‹åº¦&lt;/li&gt;
        &lt;/ul&gt;
      &lt;/li&gt;
      &lt;li&gt;ç®¡ç†å±‚çš„è¡¨ç°
        &lt;ul&gt;
          &lt;li&gt;å½“å¹´ç”»çš„é¥¼ï¼Œæ˜¯ä¸æ˜¯åšåˆ°äº†ï¼Œè¿˜æ˜¯åªä¼šè¯´å¤§è¯ï¼ˆæƒ³åˆ°äº†ä¹è§†è¿˜æœ‰ç‰¹æ–¯æ‹‰è¿™ä¸ªä¾‹å­ï¼‰&lt;/li&gt;
          &lt;li&gt;æ˜¯ä¸æ˜¯åªæ˜¯åœ¨ç»™ç®¡ç†å±‚è°‹æ±‚åˆ©ç›Š&lt;/li&gt;
        &lt;/ul&gt;
      &lt;/li&gt;
      &lt;li&gt;è´¢åŠ¡å®åŠ›å’Œèµ„æœ¬ç»“æ„ï¼šåªæœ‰æ™®é€šè‚¡å’Œå¤§é‡ç›ˆä½™ç°é‡‘çš„å…¬å¸çš„è‚¡ç¥¨æ›´å€¼å¾—æŒæœ‰
        &lt;ul&gt;
          &lt;li&gt;è¿‡å»10å¹´çš„è¥ä¸šç°é‡‘æµæ˜¯ä¸æ˜¯åœ¨ç¨³å®šå¢é•¿&lt;/li&gt;
          &lt;li&gt;è¿‡å»10å¹´ï¼Œæ‰€æœ‰è€…æ”¶ç›Šï¼ˆå‡€æ”¶ç›ŠåŠ ä¸Šæ‘Šé”€å’ŒæŠ˜æ—§ï¼Œå†å‡å»æ­£å¸¸çš„èµ„æœ¬æ”¯å‡ºï¼‰ä¸€ç›´æŒ‰é«˜äº6%çš„é€Ÿåº¦å¢é•¿&lt;/li&gt;
          &lt;li&gt;é•¿æœŸè´Ÿå€ºä½äºæ€»èµ„æœ¬çš„50%&lt;/li&gt;
        &lt;/ul&gt;
      &lt;/li&gt;
      &lt;li&gt;è‚¡æ¯è®°å½•
        &lt;ul&gt;
          &lt;li&gt;ä¸æ–­åˆ†å‰²è‚¡ç¥¨æ˜¯ä¸€ä¸ªå¾ˆä¸å¥½çš„ä¿¡å·&lt;/li&gt;
          &lt;li&gt;å…¬å¸åº”è¯¥åœ¨è‚¡ç¥¨ä»·å€¼ä½çš„æ—¶å€™è¿›è¡Œå›è´­&lt;/li&gt;
        &lt;/ul&gt;
      &lt;/li&gt;
      &lt;li&gt;å½“æœŸè‚¡æ¯æ”¶ç›Šç‡&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;æ ¼è€å»ºè®®å¤§å®¶æ§åˆ¶è‚¡ç¥¨çš„æ•°é‡ï¼Œè¿™ä¸ªå»ºè®®åœ¨ç°åœ¨ä»ç„¶éå¸¸å®ç”¨ã€‚æœ€è¿‘çœ‹è€æçš„è§†é¢‘ï¼Œè€æä¹Ÿè¯´äº†è¿™ä¸€ç‚¹ï¼Œä¹Ÿæ€»ç»“äº†æœ€è¿‘æŠ•èµ„é€‰è‚¡è¿‡å¤šå¯¼è‡´æ²¡æœ‰è¶³å¤Ÿçš„ç²¾åŠ›æ¥è·Ÿç›˜ï¼Œè€Œå¯¼è‡´äº†äºæŸã€‚åœ¨å½“å‰çš„ç¯å¢ƒä¸‹ï¼Œä¹°ETFæ˜¯ä¸€ä¸ªè›®ä¸é”™çš„é€‰æ‹©ã€‚&lt;/li&gt;
  &lt;li&gt;æ ¼è€ä¹Ÿæ¯”è¾ƒæ¨èå®šæœŸçš„è¿›è¡Œèµ„äº§çš„é…ç½®ï¼Œç¡®ä¿è¯åˆ¸å’Œè‚¡ç¥¨èƒ½å¤Ÿä¿æŒä¸€å®šçš„æ¯”ä¾‹ã€‚å¦ä¸€ä¸ªå°±æ˜¯å®šæœŸçš„æ‹¿å‡ºä¸€äº›é’±æ¥ç¨‹åºåŒ–çš„è¿›è¡Œè‚¡ç¥¨æŠ•èµ„ã€‚æ¥å°½å¯èƒ½çš„çº¦æŸè‡ªå·±ã€‚&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;è®¡åˆ’é˜…è¯»ä¹¦ç›®&quot;&gt;è®¡åˆ’é˜…è¯»ä¹¦ç›®&lt;/h3&gt;
&lt;p&gt;è¿™ä¸¤æœ¬ä¹¦éƒ½æ˜¯å±äºæ¯”å…¥é—¨å‘çš„ä¹¦ç±ï¼Œè€Œä¸”æ›´å¤šçš„æ˜¯é’ˆå¯¹æŠ•èµ„ç†å¿µè€Œä¸æ˜¯ä¸€äº›å®é™…çš„æŠ€æœ¯æ€§æ“ä½œã€‚æ¥ä¸‹æ¥æˆ‘æ‰“ç®—å¥½å¥½ç ”ç©¶ä¸€ä¸‹å®šæŠ•è¿™ä¸ªæ–¹æ³•ï¼Œæ‰“ç®—é˜…è¯»ä¸€ä¸‹ã€ŠæŒ‡æ•°åŸºé‡‘æŠ•èµ„æŒ‡å—ã€‹è¿™æœ¬ä¹¦ï¼Œäº‰å–åœ¨é˜…è¯»å®Œè¿™æœ¬ä¹¦ç±ä¹‹åï¼Œèƒ½æ€»ç»“å‡ºä¸€å¥—é€‚ç”¨äºè‡ªå·±çš„æŒ‡æ•°åŸºé‡‘å®šæŠ•çš„æ–¹æ³•å’Œè®¡åˆ’ã€‚åˆ°æ—¶å€™ä¹Ÿä¼šè·Ÿå¤§å®¶ç»§ç»­åˆ†äº«æˆ‘çš„å¿ƒå¾—ä½“ä¼šã€‚&lt;/p&gt;
</description>
        <pubDate>Sun, 04 Apr 2021 00:00:00 -0700</pubDate>
        <link>https://pyemma.github.io//Newbee-Reading-Investment-Books-I/</link>
        <guid isPermaLink="true">https://pyemma.github.io//Newbee-Reading-Investment-Books-I/</guid>
      </item>
    
      <item>
        <title>æŠ•èµ„å°ç™½å­¦ä¹ è¯»è´¢æŠ¥</title>
        <description>&lt;p&gt;æœ€è¿‘å¼€å§‹æ­¥å…¥æŠ•èµ„é¢†åŸŸï¼Œæ‰“ç®—åœ¨è‡ªå·±çš„åšå®¢é‡Œé¢ä¹Ÿä¸“é—¨å¼€ä¸€ä¸ªç‰ˆå—ã€‚ä¸»è¦çš„ç›®çš„ä¸€æ–¹é¢æ˜¯åšé˜¶æ®µæ€§çš„æ€»ç»“ï¼Œå’Œå¤§å®¶äº¤æµå­¦ä¹ ï¼›å¦ä¸€æ–¹é¢ä¹Ÿæ˜¯ç»™è‡ªå·±çš„åšå®¢å¢åŠ ä¸€äº›å¤šæ ·æ€§ï¼Œè€Œä¸æ˜¯å•çº¯çš„æŠ€æœ¯æ€§åšå®¢ï¼ˆæ ¹æœ¬æ²¡äººè¯» TATï¼‰ã€‚&lt;/p&gt;

&lt;p&gt;æˆ‘çš„èƒŒæ™¯æ˜¯çº¯ç²¹çš„æŠ•èµ„å°ç™½ï¼Œå±äºé‚£ç§è¿è‚¡ç¥¨è¿˜æœ‰æœŸæƒéƒ½åˆ†ä¸æ¸…æ¥šçš„é‚£ç§24kçº¯æŠ•èµ„å°ç™½ï¼Œè€Œä¸”ä¹‹å‰è¿˜ä¸€ç›´ä¸æ‡ˆäºææŠ•èµ„ã€‚åœ¨è€å©†çš„åŠï¼ˆweiï¼‰è¯´ï¼ˆxieï¼‰ä¹‹ä¸‹ï¼Œç»ˆäºå¼€å§‹å°è¯•å­¦ä¹ ã€‚æˆ‘å­¦ä¹ ä¸œè¥¿æ¯”è¾ƒå–œæ¬¢åšä¸»é¢˜æ€§çš„å­¦ä¹ ï¼Œæœ‰ç‚¹ç±»ä¼¼äºä¸»é¢˜é˜…è¯»ã€‚é€šå¸¸æˆ‘ä¼šæ‰¾åˆ°ä¸€ä¸ªä¸»é¢˜ï¼ˆè¿™ä¸ªä¸»é¢˜å¯èƒ½æ˜¯å¬åˆ«äººæåˆ°çš„ï¼Œæˆ–è€…æ˜¯åœ¨ç½‘ç«™ä¸Šå¶ç„¶çœ‹åˆ°çš„ä¸€ä¸ªä¸»é¢˜ï¼‰ï¼Œç„¶åå°½å¯èƒ½æœç´¢ç›¸å…³çš„èµ„æ–™å­¦ä¹ ï¼Œæœ€åæ•´ç†ä¸€ä¸‹è¦ç‚¹ã€‚åœ¨è¿™ä¸€ç¯‡åšå®¢é‡Œé¢ï¼Œæˆ‘å°±æ‰“ç®—å…ˆä»‹ç»ä¸€ä¸‹ï¼Œè‡ªå·±æœ€è¿‘åœ¨å­¦ä¹ çš„å…³äº&lt;strong&gt;é˜…è¯»è´¢æŠ¥çš„ä¸€äº›è¦ç‚¹&lt;/strong&gt;ã€‚&lt;/p&gt;

&lt;h3 id=&quot;å»å“ªé‡Œæ‰¾è´¢æŠ¥&quot;&gt;å»å“ªé‡Œæ‰¾è´¢æŠ¥&lt;/h3&gt;
&lt;p&gt;æ‰¾ä¸Šå¸‚å…¬å¸çš„è´¢æŠ¥ä¿¡æ¯æœ‰å¾ˆå¤šç§çš„é€”å¾„ï¼Œåœ¨è¿™é‡Œæˆ‘ä»‹ç»ä¸¤ç§æˆ‘ä½¿ç”¨è¿‡çš„æ–¹æ³•ï¼š&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;ç¬¬ä¸€ç§æ˜¯å»å…¬å¸çš„å®˜æ–¹ç½‘ç«™ï¼Œç„¶åæ‰¾å¸¦æœ‰investorå­—æ ·çš„é“¾æ¥ã€‚ä»¥æˆ‘æœ€è¿‘åœ¨ç ”ç©¶çš„Palantirè¿™å®¶å…¬å¸æ¥è¯´ï¼Œåœ¨ä»–å®¶çš„å®˜ç½‘æœ€åº•ä¸‹ï¼Œæœ‰ä¸€ä¸ª &lt;a href=&quot;https://investors.palantir.com/&quot;&gt;Investor Relations&lt;/a&gt; çš„é“¾æ¥ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚æ¥åˆ°æ–°é¡µé¢ä¸Šä¹‹åå¯ä»¥æ‰¾åˆ°ä¸€ä¸ªå«åš &lt;em&gt;Financials&lt;/em&gt; çš„ä¸‹æ‹‰é€‰é¡¹å•ï¼Œåœ¨è¿™é‡Œå¯ä»¥æ‰¾åˆ°ä¸€ä¸ª &lt;em&gt;Quartely Results&lt;/em&gt; å’Œ &lt;em&gt;SEC Filing&lt;/em&gt; çš„é€‰é¡¹ã€‚ä¸€èˆ¬æˆ‘ä»¬å°ç™½è¯»ä¸€è¯» &lt;a href=&quot;https://investors.palantir.com/financials/quarterly-results&quot;&gt;Quartely Results&lt;/a&gt; ä¸Šçš„ä¸œè¥¿å°±å¯ä»¥å•¦ï¼šæœ‰ç²¾ç®€ç‰ˆçš„è´¢æŠ¥ï¼Œè¿˜æœ‰åˆ¶ä½œç²¾ç¾çš„ PPT ä¾›ä½ é€‰æ‹©é˜…è¯»ã€‚å½“ç„¶ä¹Ÿå¯ä»¥çœ‹æ›´åŠ æ­£å¼çš„è´¢æŠ¥æ¯”å¦‚ K10 å¹´æŠ¥ä»€ä¹ˆçš„ï¼Œä½†æ˜¯é‚£ä¸ª100å¤šé¡µçš„æ–‡æ¡£è¯»èµ·æ¥å¯çœŸçš„ä¸è½»æ¾å‘€ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;div style=&quot;text-align: center&quot;&gt;
  &lt;img src=&quot;/assets/pltr_investor.png&quot; alt=&quot;pltr_investor&quot; title=&quot;Palantir Investor&quot; width=&quot;200&quot; height=&quot;150&quot; /&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;ç¬¬äºŒä¸­æ–¹æ³•æ˜¯ä½¿ç”¨ &lt;a href=&quot;https://finance.yahoo.com/&quot;&gt;Yahoo Finance&lt;/a&gt; ç½‘ç«™ã€‚åœ¨æœç´¢æ é‡Œé¢è¾“å…¥æƒ³è¦æŸ¥è¯¢çš„å…¬å¸çš„è‚¡ç¥¨ä»£ç ï¼ˆPLTR)æˆ–è€…å…¬å¸åå­—ï¼Œç„¶åæˆ‘ä»¬åœ¨ç»“æœé¡µé¢ä¸Šèƒ½æ‰¾åˆ°ä¸€ä¸ª Financials çš„tabï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚åœ¨è¿™é‡Œæˆ‘ä»¬ä¹Ÿèƒ½å¾—åˆ°å…¬å¸çš„è´¢æŠ¥ä¿¡æ¯ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;div style=&quot;text-align: center&quot;&gt;
  &lt;img src=&quot;/assets/pltr_yahoo.png&quot; alt=&quot;pltr_yahoo&quot; title=&quot;Palantir Yahoo Finance&quot; width=&quot;600&quot; height=&quot;300&quot; /&gt;
&lt;/div&gt;

&lt;h3 id=&quot;æ€ä¹ˆè¯»è´¢æŠ¥&quot;&gt;æ€ä¹ˆè¯»è´¢æŠ¥&lt;/h3&gt;

&lt;p&gt;è´¢æŠ¥ä¸€å…±æœ‰ä¸‰ä¸ªè¡¨æ ¼ï¼Œåˆ†åˆ«æ˜¯ç›ˆåˆ©è¡¨(income sheet)ï¼Œèµ„äº§è´Ÿå€ºè¡¨(balance sheet)å’Œç°é‡‘æµè¡¨(cash flow sheet)ã€‚åœ¨çœ‹è¿™äº›è¡¨çš„æ—¶å€™åŸºæœ¬ä¸Šè¦éµå®ˆä¸‹é¢çš„å‡ æ ·åŸåˆ™ï¼š&lt;/p&gt;
&lt;ol&gt;
  &lt;li&gt;ç»å¯¹å€¼(absolute number)å¾ˆé‡è¦ï¼Œä½†æ˜¯æ¯”ä¾‹(ratio)åŒæ ·å¾ˆé‡è¦ï¼Œç”šè‡³æ˜¯æ›´åŠ çš„é‡è¦ã€‚&lt;/li&gt;
  &lt;li&gt;å•çº¯çœ‹ä¸€å¹´çš„æ•°æ®ä¸å¤ŸåŠ²å„¿ï¼Œéœ€è¦ç»¼åˆç€çœ‹å†å¹´çš„æ•°æ®ï¼Œæ¥è§‚å¯Ÿè¶‹åŠ¿ï¼ˆå¯¼æ•°å•ŠåŒå­¦ä»¬ï¼‰ï¼Œä»¥æ­¤æ¥åˆ¤æ–­å…¬å¸æœªæ¥çš„å‘å±•å‰æ™¯ã€‚&lt;/li&gt;
  &lt;li&gt;å•çº¯çœ‹ä¸€å®¶å…¬å¸çš„ä¹Ÿè¿˜ä¸å¤ŸåŠ²å„¿ï¼Œéœ€è¦è·ŸåŒä¸€è¡Œä¸šçš„å…¶ä»–å…¬å¸æ¥æ¯”è¾ƒï¼Œä»è€Œäº†è§£è¿™å®¶å…¬å¸åœ¨è¡Œä¸šå†…çš„æ•°æ®æ˜¯ä¸æ˜¯è¶³å¤Ÿä¼˜ç§€ã€‚&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;è¿™ä¸‰å¼ è¡¨ä¸­ï¼Œæˆ‘ä¸ªäººæ„Ÿè§‰æœ€æœ‰ç”¨çš„è¿˜æ˜¯ç›ˆåˆ©è¡¨å’Œèµ„äº§è´Ÿå€ºè¡¨ï¼Œç°é‡‘æµè¡¨æˆ‘åˆ°ç°åœ¨ä¹Ÿè¿˜æ²¡æœ‰ç ”ç©¶é€å½»ï¼Œæ‰€ä»¥ä¹Ÿä¸æ•¢è¯´å¾—å¤ªå¤šã€‚&lt;/p&gt;

&lt;p&gt;é¦–å…ˆæˆ‘ä»¬çœ‹çœ‹çœ‹ç›ˆåˆ©è¡¨ï¼Œé€šè¿‡è¿™å¼ è¡¨æˆ‘ä»¬å¯ä»¥çŸ¥é“è¿™å®¶å…¬å¸è¿è¥çš„å¦‚ä½•ã€‚é¦–å…ˆå¯ä»¥çœ‹çš„æ˜¯ä¸€å®¶å…¬å¸çš„è¥æ”¶(Revenue)ã€‚åŒæ—¶æˆ‘ä»¬è¿˜å¯ä»¥çœ‹åˆ°æ”¯å‡º(Cost of Revenue)ï¼Œä¹Ÿå°±æ˜¯ç›¸åº”çš„æ”¯å‡ºæœ‰å¤šå°‘ã€‚è¿™ä¸¤é¡¹ç›¸å‡ï¼Œæˆ‘ä»¬èƒ½å¾—åˆ°å…¬å¸çš„æ¯›åˆ©æ¶¦(Gross Profit)ã€‚åŒæ—¶æˆ‘ä»¬è¿˜èƒ½ä»è¡¨ä¸Šå¾—åˆ°å…¬å¸å…¶ä»–çš„ä¸€äº›operation costï¼Œæ¯”å¦‚ç§‘ç ”(R&amp;amp;D)è¿˜æœ‰å¸‚åœºè¥é”€(Marketing)ä¹‹ç±»çš„ã€‚é™¤æ­¤ä¹‹å¤–è¿˜æœ‰è¦äº¤çš„ç¨å•¥çš„ã€‚å¦‚æœæˆ‘ä»¬æŠŠè¿™äº›costä¹Ÿéƒ½ä»åº”æ”¶é‡Œé¢æ‰£é™¤çš„è¯ï¼Œå°±å¾—åˆ°äº†ä¼ è¯´ä¸­çš„å‡€åˆ©æ¶¦(Net Profit)æˆ–è€…å‡€äºæŸ(Net Loss)ã€‚æˆ‘ä»¬æŠŠæ¯›åˆ©æ¶¦è¿˜æœ‰å‡€åˆ©æ¶¦åˆ†åˆ«è·Ÿè¥æ”¶ç›¸é™¤ï¼Œå°±å¾—åˆ°äº†æ¯›åˆ©ç‡(Gross Margin)è·Ÿå‡€åˆ©ç‡(Net Margin)ã€‚ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸ªä¾‹å­ï¼Œæ¯”è¾ƒä¸€ä¸‹Facebookè¿˜æœ‰Snapchatè¿™ä¸¤å®¶å…¬å¸çš„çŠ¶å†µã€‚&lt;/p&gt;

&lt;div style=&quot;text-align: center&quot;&gt;
  &lt;img src=&quot;/assets/fb_income_sheet.png&quot; alt=&quot;fb_income_sheet&quot; title=&quot;Facebook Income Sheet&quot; width=&quot;800&quot; height=&quot;400&quot; /&gt;
  &lt;center&gt;Facebook&lt;/center&gt;
  &lt;img src=&quot;/assets/snap_income_sheet.png&quot; alt=&quot;snap_income_sheet&quot; title=&quot;Snapchat Income Sheet&quot; width=&quot;800&quot; height=&quot;400&quot; /&gt;
  &lt;center&gt;Snapchat&lt;/center&gt;
&lt;/div&gt;

&lt;p&gt;ä»ä¸Šé¢çš„è¡¨æ ¼ä¸­æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œ2020å¹´å…¨å¹´Facebookçš„è¥æ”¶æ¯”2019å¹´å¢é•¿äº†å¤§çº¦21.59%ï¼ŒSnapchatåˆ™æ˜¯38.16%ã€‚è¯´æ˜Snapchatçš„å¢é•¿é€Ÿåº¦è¿œè¿œè¶…è¿‡Facebookï¼Œè¿™ä¸ªä¹Ÿæ˜¯æ¯”è¾ƒç¬¦åˆæˆ‘ä»¬çš„é¢„æœŸçš„ï¼Œå› ä¸ºFacebookå·²ç»æ˜¯ä¸€ä¸ªå¤§å‹çš„éå¸¸æˆç†Ÿçš„ä¼ä¸šäº†ï¼Œè€ŒSnapchatä»»ç„¶å¤„äºä¸€ä¸ªé«˜é€Ÿçš„å‘å±•é˜¶æ®µã€‚è¿™ä¸ªä»ä¸¤å®¶å…¬å¸æœ€åçš„å‡€åˆ©æ¶¦ä¹Ÿå¯ä»¥çœ‹å‡ºæ¥ï¼ŒFacebookæ˜¯æœ‰å®ç°ç›ˆåˆ©çš„ï¼Œè€ŒSnapchatä»»ç„¶æ˜¯å¤„äºäºæŸçš„çŠ¶æ€ã€‚2020å¹´Facebookçš„å‡€åˆ©ç‡å¤§æ¦‚æ˜¯33.9%ï¼Œç›¸æ¯”è¾ƒ2019å¹´çš„26.1%ï¼Œæœ‰ä¸€ä¸ªæ¯”è¾ƒå¤§çš„æå‡ã€‚è¿™ä¸ªå¯¹äºç§‘æŠ€å…¬å¸æ¥è¯´åœ¨2020å¹´æ˜¯ä¸€ä¸ªæ¯”è¾ƒæ™®éçš„å½±å“ï¼Œç”±äºç–«æƒ…çš„å½±å“ï¼Œç§‘æŠ€å…¬å¸çš„ä¸šåŠ¡å¾€å¾€å®ç°äº†ä¸€ä¸ªçˆ†å‘å¼çš„å¢é•¿ã€‚&lt;/p&gt;

&lt;p&gt;å·´è²ç‰¹è€çˆ·å­å°±å¾ˆçœ‹é‡å…¬å¸çš„æ¯›åˆ©ç‡è¿˜æœ‰å‡€åˆ©ç‡ï¼Œä»–çš„ä¸€ä¸ªå»ºè®®æ˜¯ï¼Œä¸€ä¸ªå…¬å¸çš„æ¯›åˆ©ç‡åœ¨40%ä»¥ä¸Šï¼Œå‡€åˆ©ç‡åœ¨20%ä»¥ä¸Šçš„è¯ï¼Œé‚£ä¹ˆè¿™ä¸ªå…¬å¸å°±æ˜¯è¿˜è›®ä¸é”™çš„ã€‚&lt;/p&gt;

&lt;p&gt;æœ‰äº†å‡€åˆ©æ¶¦ï¼Œæˆ‘ä»¬å†é™¤ä»¥å…¨éƒ¨çš„è‚¡ä¸œæƒç›Šçš„è¯ï¼Œé‚£ä¹ˆå°±èƒ½å¾—åˆ°æ¯è‚¡æ”¶ç›Š(Earning Per Share)ã€‚è¿™ä¸ªä¸ç”¨æˆ‘ä»¬è‡ªå·±æ‰‹ç®—ï¼Œåœ¨ç›ˆåˆ©è¡¨ä¸­å°±å·²ç»ç»™äº†ã€‚Facebookçš„EPSä»2019å¹´çš„6.48æ¶¨åˆ°äº†10.22ï¼Œå®ç°äº†57%çš„å¢é•¿ã€‚EPSè¿˜æœ‰ä¸€ä¸ªå¾ˆé‡è¦çš„ç”¨é€”å°±æ˜¯ç”¨æ¥è®¡ç®—P/Eå€¼ï¼Œè¿™ä¸ªå€¼åœ¨ä»·å€¼æŠ•èµ„é‡Œé¢æ˜¯ä¸€ä¸ªå¾ˆé‡è¦çš„æŒ‡æ ‡ï¼Œç”¨æ¥è¡¡é‡ä¸€å®¶å…¬å¸çš„è‚¡ç¥¨æ˜¯è¢«é«˜ä¼°è¿˜æ˜¯ä½ä¼°äº†ã€‚åœ¨ã€Šèªæ˜çš„æŠ•èµ„è€…ã€‹ä¸€ä¹¦ä¸­ï¼Œä½œè€…å°±å»ºè®®å½“P/Eå€¼è¶…è¿‡40çš„æ—¶å€™ï¼Œå¯ä»¥è€ƒè™‘å–å‡ºè‚¡ç¥¨ã€‚è¿™æ¡å»ºè®®åœ¨ç°åœ¨çš„æˆé•¿è‚¡ä¸­å¯èƒ½ä¸æ˜¯å¾ˆå®ç”¨ï¼ˆP/E è¶…é«˜çš„è‚¡ç¥¨å¤ªå¤šäº†ï¼‰ã€‚Facebookçš„P/Eå€¼ç°åœ¨æ˜¯26å·¦å³ï¼ŒSnapchatçš„åˆ™æ²¡æœ‰è¿™ä¸ªå€¼ï¼Œå› ä¸ºå…¶EPSæ˜¯è´Ÿæ•°ï¼ˆæ²¡æœ‰å®ç°ç›ˆåˆ©ï¼‰ã€‚&lt;/p&gt;

&lt;p&gt;ä¸åŒçš„è¡Œä¸šï¼Œå…¶å‡€åˆ©ç‡ï¼ŒEPSå¯èƒ½ä¼šå¾ˆä¸ä¸€æ ·ï¼Œè¿™ä¸ªæ˜¯åˆè¡Œä¸šæœ¬èº«çš„æ€§è´¨å†³å®šçš„ã€‚æˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹è‹¹æœå…¬å¸çš„æ•°æ®ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º&lt;/p&gt;
&lt;div style=&quot;text-align: center&quot;&gt;
  &lt;img src=&quot;/assets/apple_income_sheet.png&quot; alt=&quot;apple_income_sheet&quot; title=&quot;Apple Income Sheet&quot; width=&quot;800&quot; height=&quot;400&quot; /&gt;
  &lt;center&gt;Apple&lt;/center&gt;
&lt;/div&gt;

&lt;p&gt;è‹¹æœå…¬å¸2020å¹´çš„å‡€åˆ©ç‡æ˜¯26%å·¦å³ï¼Œæ¯”Facebookä½äº†å¾ˆå¤šã€‚å…¶EPSä»2019å¹´çš„2.99å¢é•¿åˆ°äº†2020å¹´çš„3.31ï¼Œå®ç°äº†10.7%çš„å¢é•¿ã€‚è¿™äº›æ•°æ®æ¯”Facebookä½ï¼Œä½†æ˜¯è¿™ä¸æ¯«æ²¡æœ‰å½±å“å¤§å®¶å¯¹å…¶çš„å–œçˆ±ã€‚è‹¹æœå…¬å¸çš„P/Eå€¼æ‰“åˆ°äº†32å·¦å³ï¼Œè¯´æ˜æŠ•èµ„è€…å¯¹äºè‹¹æœå…¬å¸çš„å‰æ™¯æ˜¯æ›´åŠ çœ‹å¥½çš„ã€‚è¿™ä¸ªä¾‹å­å°±æ˜¯æƒ³å‘Šè¯‰å¤§å®¶ï¼Œå¤§å®¶åœ¨æ¯”è¾ƒå…¬å¸çš„æ—¶å€™ä¸€å®šè¦åŒç±»åˆ«è¿›è¡Œæ¯”è¾ƒï¼Œå¦åˆ™æ•°æ®æ²¡æœ‰ä»€ä¹ˆæ„ä¹‰ï¼ˆcall back ç¬¬ä¸‰ç‚¹ï¼‰ã€‚&lt;/p&gt;

&lt;p&gt;ä¸‹ä¸€å¼ è¡¨æˆ‘ä»¬å¯ä»¥çœ‹çœ‹èµ„äº§è´Ÿå€ºè¡¨ï¼Œè¿™ä¸ªè¡¨åæ˜ äº†å…¬å¸çš„å€ºåŠ¡æƒ…å†µã€‚æ€»ä½“ä¸Šä¸€å¥è¯ï¼Œå…¬å¸çš„èµ„äº§(Asset)=ä»é“¶è¡Œå€Ÿæ¥çš„é’±(Liabilities) + ä»è‚¡ä¸œä»¬å€Ÿæ¥çš„é’±(Shareholderâ€™s equity)ã€‚åœ¨è¿™å¼ è¡¨é‡Œé¢ï¼Œæˆ‘ä»¬å…¶å®å°±æ˜¯ä¸»è¦çœ‹çœ‹ç°é‡‘ä»¥åŠç°é‡‘ç­‰ä»·ç‰©ï¼Œæ¥ç¡®ä¿å…¬å¸çš„è´¢åŠ¡çŠ¶å†µæ¯”è¾ƒçš„å¥åº·ã€‚Facebook 2020å¹´çš„ç°é‡‘å¤§æ¦‚17576Mï¼Œå’Œ2019å¹´çš„19079Mæ²¡æœ‰ä»€ä¹ˆå¤ªå¤§çš„å˜åŒ–ï¼Œè¿™ç§ç¨³å®šçš„ç°é‡‘å‚¨å¤‡å°±æ˜¯å…¬å¸æ¯”è¾ƒå¥åº·çš„è¡¨ç°ã€‚è¦æ˜¯çªç„¶çœ‹åˆ°ç°é‡‘é”å‡ï¼Œé‚£å°±è¦ä»”ç»†ç ”ç©¶ç ”ç©¶æœ‰ä»€ä¹ˆçŒ«è…»äº†ã€‚åˆæ¬¡ä¹‹å¤–ï¼Œå·´è²ç‰¹è€çˆ·å­ä¹Ÿæ¨èä»”ç»†çœ‹çœ‹Retained Earningsï¼Œè¿™ä¸ªé’±å°±æ˜¯å‡€åˆ©æ¶¦æ‰£é™¤äº†è‚¡ç¥¨çš„åˆ†çº¢ä¹‹åå‰©ä¸‹æ¥çš„é’±ã€‚å·´è²ç‰¹è€çˆ·å­å¸Œæœ›çœ‹åˆ°è¿™ä¸ªé’±æ˜¯èƒ½ä¸€ç›´æœ‰å¢é•¿çš„ã€‚æˆ‘æ˜¯å¸Œæœ›è¿™ä¸ªé’±èƒ½ç¨³å®šçš„ç»´æŒåœ¨ä¸€å®šçš„æ°´å¹³ï¼Œè¿™æ ·çš„è¯æˆ‘èƒ½çŸ¥é“å…¬å¸çš„ç®¡ç†å±‚åœ¨æ‹¿è¿™äº›é’±ç”¨æ¥åŠäº‹å„¿ï¼Œè€Œä¸æ˜¯ä»…ä»…æ‹¿åœ¨æ‰‹é‡Œä¸çŸ¥é“å¹²å•¥ï¼Œä¹Ÿä¸å‘ç»™è‚¡ä¸œã€‚å¦ä¸€ç‚¹å·´è²ç‰¹è€çˆ·å­æé†’è¦å…³æ³¨çš„å°±æ˜¯æœ‰æ²¡æœ‰å¤ªå¤šçš„é•¿æœŸè´Ÿå€ºã€‚&lt;/p&gt;

&lt;p&gt;æœ€åä¸€å¼ è¡¨ç¤ºç°é‡‘æµè¡¨ã€‚è¿™å¼ è¡¨è¯¦ç»†çš„æ³¨æ˜äº†äº†å…¬å¸çš„è¥ä¸šç°é‡‘æ”¶å…¥ï¼ŒæŠ•èµ„çš„ç°é‡‘æ”¶å…¥ï¼Œä»¥åŠèèµ„çš„ç°é‡‘æ”¶å…¥ã€‚è¯´å®è¯è¿™å¼ è¡¨å…¶å®æˆ‘æ˜¯çœ‹ä¸å¤ªæ‡‚çš„ï¼Œæ‰€ä»¥ä¹Ÿå°±ä¸è¯´å¤ªå¤šäº†ã€‚&lt;/p&gt;

&lt;h3 id=&quot;ç»“è¯­&quot;&gt;ç»“è¯­&lt;/h3&gt;
&lt;p&gt;è¿™ç¯‡å°æ–‡ç« åªæ˜¯å¾ˆç²—ç•¥çš„æ€»ç»“äº†ä¸€ä¸‹æˆ‘æœ€è¿‘å­¦ä¹ åˆ°çš„è¯»è´¢æŠ¥çš„çŸ¥è¯†ï¼Œå¹¶ä¸æ˜¯éå¸¸ä¸“ä¸šçš„æ·±åº¦æ–‡ç« ï¼Œæ—¨åœ¨èƒ½èµ·åˆ°ä¸€ä¸ªæŠ›ç –å¼•ç‰ï¼Œå’Œå¤§å®¶åˆ†äº«è®¨è®ºçš„ä½œç”¨ã€‚å¦‚æœæœ‰å“ªé‡Œè¯´å¾—ä¸æ˜¯å¾ˆå‡†ç¡®ï¼Œæ¬¢è¿å¤§å®¶çš„æŒ‡æ­£ã€‚ä¹‹åå¦‚æœæˆ‘è¿˜æœ‰æ–°çš„å­¦ä¹ å‘ç°ï¼Œä¹Ÿä¼šåŠæ—¶åœ°æ›´æ–°æ¥ä¸å¤§å®¶åˆ†äº«ã€‚&lt;/p&gt;

&lt;h3 id=&quot;å‚è€ƒèµ„æ–™&quot;&gt;å‚è€ƒèµ„æ–™&lt;/h3&gt;
&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://www.youtube.com/watch?v=lBBXmim527A&quot;&gt;WARREN BUFFETT AND THE INTERPRETATION OF FINANCIAL STATEMENTS&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://www.youtube.com/watch?v=rgKKNZlgXbw&quot;&gt;è´æ‹‰è´¢ç» 192æœŸ&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://www.youtube.com/watch?v=rq9B79mNQiA&quot;&gt;å¦‚ä½•è¯»ç§‘æŠ€è‚¡çš„è´¢æŠ¥&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</description>
        <pubDate>Sat, 27 Feb 2021 00:00:00 -0800</pubDate>
        <link>https://pyemma.github.io//Newbee-Learn-to-Read-Financial-Reports/</link>
        <guid isPermaLink="true">https://pyemma.github.io//Newbee-Learn-to-Read-Financial-Reports/</guid>
      </item>
    
      <item>
        <title>MIT Distributed System Course - Raft II</title>
        <description>&lt;h2 id=&quot;introduction&quot;&gt;Introduction&lt;/h2&gt;

&lt;p&gt;In this post, we continue our work on raft implementation. The focus of this post would be the second part of raft, which is the log replication, and snapshot to optimize the size of the log.&lt;/p&gt;

&lt;p&gt;Letâ€™s first go through the high level logic of how log replica works in raft:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;When the leader sends out a log replica request, it is going to also send the new log entriesâ€™ pervious entryâ€™s term and index along the request, as well as the current committed entry index&lt;/li&gt;
  &lt;li&gt;Upon receiving the request, followers/candidates would perform the regular check as usual&lt;/li&gt;
  &lt;li&gt;Then, followers would check the pervious entryâ€™s term and index send by the leader to see if there is any conflict with its own log&lt;/li&gt;
  &lt;li&gt;If there is no conflict, then followers would copy over the new entries sent by the leader, otherwise it would reject this request&lt;/li&gt;
  &lt;li&gt;Once the leader receive the reply from a follower, if it success, then it would update its nextIndex (the next index need to be send to a particular server) and matchIndex (the highest index to be known have been replicated on a particular server); if it fails, then the leader would reduce the nextIndex and retry the request&lt;/li&gt;
  &lt;li&gt;Periodically, leader would check the matchIndex and see if there could be new log to be committed&lt;/li&gt;
  &lt;li&gt;If a follower see that the commit index passed from leader is greater than its current commit index, it would update its current commit index as well&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;From this entire process, leader would never change its own log entries and acts as a dictator to ask followers to replica its authority. Also, leader would never commit log entries from past terms to show respect to former dictators :). It always commits log from its current term, but the entries from past term would be implicitly committed.&lt;/p&gt;

&lt;p&gt;The section 5.4.3 has provided a pretty good explanation on the safety guarantee of the raft: &lt;em&gt;Leader Completeness Property&lt;/em&gt;. Below is the full list of RAFT properties introduced in the paper.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/raft_property.png&quot; alt=&quot;RAFT properties&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;log-replica&quot;&gt;Log Replica&lt;/h2&gt;

&lt;p&gt;Two functions plays a key role on Log Replica: updated version of &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;AppendEntries&lt;/code&gt; by followers and &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;replicaLog&lt;/code&gt; by leaders.&lt;/p&gt;

&lt;p&gt;We have already provided an implementation of &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;AppendEntries&lt;/code&gt; in the last post so that the leader could use it to send heartbeats to followers. We extend the functionality of &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;AppendEntries&lt;/code&gt; to make it support log replica.&lt;/p&gt;

&lt;p&gt;Here is the new implementation of the function (or take a look at &lt;a href=&quot;https://github.com/pyemma/mit-distributed-system/commit/4ca09b83b23325f14bfceae8161f366a4ddc030d&quot;&gt;highlight of the change&lt;/a&gt;).&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-go&quot; data-lang=&quot;go&quot;&gt;&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Raft&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;AppendEntries&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;args&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;AppendEntriesArgs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;reply&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;AppendEntriesReply&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mu&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Lock&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;defer&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mu&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Unlock&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;

	&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Term&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;currentTerm&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;reply&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Term&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;currentTerm&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;reply&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Success&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;false&lt;/span&gt;
		&lt;span class=&quot;k&quot;&gt;return&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

	&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Term&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;currentTerm&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;convertToFollower&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Term&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

	&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Term&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;currentTerm&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;state&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Candidate&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;convertToFollower&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Term&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

	&lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;resetElectionTimer&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;

	&lt;span class=&quot;n&quot;&gt;reply&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Success&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;true&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;// default to true, all the logic below would set it to false&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;reply&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Term&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;currentTerm&lt;/span&gt;

	&lt;span class=&quot;n&quot;&gt;DPrintf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;Server %d, args perv log %d, args perv term %d, my log %v&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;me&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;PrevLogIndex&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;PrevLogTerm&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;logEntries&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;pervCheck&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;checkPerv&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;PrevLogIndex&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;PrevLogTerm&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

	&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;pervCheck&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;false&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;reply&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Term&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;currentTerm&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;reply&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Success&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;false&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;updateXInfo&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;PrevLogIndex&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;PrevLogTerm&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;reply&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;DPrintf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;XTerm %d, XIndex %d, XLen %d&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;reply&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;XTerm&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;reply&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;XIndex&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;reply&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;XLen&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
		&lt;span class=&quot;k&quot;&gt;return&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

	&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;len&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Entries&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;checkCommit&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;LeaderCommit&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
		&lt;span class=&quot;k&quot;&gt;return&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

	&lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;checkAndCopy&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;PrevLogIndex&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Entries&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;checkCommit&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;LeaderCommit&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;return&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;The key new logic we introduced is as follow:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;We introduce a new function, which is &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;checkPerv&lt;/code&gt;. This function is used to check if there is any conflict entry from followerâ€™s current log with the pervious log entry from leader. Note that even if the request is a heartbeat, where there is no new entry sent from leader, we still needs to do this check as described in the algorithm, so that follower could pass some useful information back to the leader to update the leaderâ€™s internal state about followers&lt;/li&gt;
  &lt;li&gt;We also introduce a function called &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;checkCommit&lt;/code&gt; to see if the leader has send a commit index that is larger than followerâ€™s current commit index on record&lt;/li&gt;
  &lt;li&gt;Once the pervious entry check is pass, we use the function &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;checkAndCopy&lt;/code&gt; to do the actual copy and overwriting work, where we find the first entry that is different with the new entries sent by leader, and copy-paste from that point.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;As we have seen the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;AppendEntries&lt;/code&gt; RPC callâ€™s logic, letâ€™s take a look at how leader is going to send request to followers and process responses from followers. In the pervious post, we have implemented a function called &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;sendHeartbeat&lt;/code&gt;. We rename it to &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;replicaLog&lt;/code&gt; and extend its functionality, with a parameters to control whether we would love to use it to send heartbeats, or send real log entries. Below is the implementation (or take a look at &lt;a href=&quot;https://github.com/pyemma/mit-distributed-system/commit/4ca09b83b23325f14bfceae8161f366a4ddc030d&quot;&gt;highlight of the change&lt;/a&gt;).&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-go&quot; data-lang=&quot;go&quot;&gt;&lt;span class=&quot;c&quot;&gt;// replicaLog is the function used by leader to send log to replica&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Raft&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;replicaLog&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;isHeartbeat&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;bool&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;term&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;currentTerm&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;isHeartbeat&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;true&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;heartbeatTime&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;time&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Now&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;// rest the heartbeatTime&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mu&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Unlock&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;

	&lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;peer&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;range&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;peers&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;peer&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;me&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
			&lt;span class=&quot;k&quot;&gt;continue&lt;/span&gt;
		&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

		&lt;span class=&quot;k&quot;&gt;go&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;server&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;term&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;isHeartbeat&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;bool&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
			&lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mu&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Lock&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
			&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;state&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Leader&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;||&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;currentTerm&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;term&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
				&lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mu&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Unlock&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
				&lt;span class=&quot;k&quot;&gt;return&lt;/span&gt;
			&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

			&lt;span class=&quot;n&quot;&gt;nextIdx&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nextIndex&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;server&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
			&lt;span class=&quot;n&quot;&gt;lastIdx&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;len&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;logEntries&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;
			&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;lastIdx&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nextIdx&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;isHeartbeat&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;false&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;// in this case, we have nothing to update&lt;/span&gt;
				&lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mu&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Unlock&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
				&lt;span class=&quot;k&quot;&gt;return&lt;/span&gt;
			&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

			&lt;span class=&quot;n&quot;&gt;perLogIdx&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nextIdx&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;
			&lt;span class=&quot;n&quot;&gt;perLogTerm&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;logEntries&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;perLogIdx&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Term&lt;/span&gt;

			&lt;span class=&quot;n&quot;&gt;entries&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;logEntries&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nextIdx&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
			&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;isHeartbeat&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
				&lt;span class=&quot;n&quot;&gt;entries&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;make&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;([]&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;LogEntry&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
			&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

			&lt;span class=&quot;n&quot;&gt;args&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;AppendEntriesArgs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
				&lt;span class=&quot;n&quot;&gt;Term&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;         &lt;span class=&quot;n&quot;&gt;term&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
				&lt;span class=&quot;n&quot;&gt;LeaderId&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;     &lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;me&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
				&lt;span class=&quot;n&quot;&gt;PrevLogIndex&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;perLogIdx&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
				&lt;span class=&quot;n&quot;&gt;PrevLogTerm&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;  &lt;span class=&quot;n&quot;&gt;perLogTerm&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
				&lt;span class=&quot;n&quot;&gt;Entries&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;      &lt;span class=&quot;n&quot;&gt;entries&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
				&lt;span class=&quot;n&quot;&gt;LeaderCommit&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;commitIndex&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
			&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

			&lt;span class=&quot;n&quot;&gt;reply&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;AppendEntriesReply&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{}&lt;/span&gt;
			&lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mu&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Unlock&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;

			&lt;span class=&quot;n&quot;&gt;ok&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sendAppendEntries&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;server&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;reply&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

			&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ok&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
				&lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mu&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Lock&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
				&lt;span class=&quot;n&quot;&gt;DPrintf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;%d append entries get reply from %d, %t on term %d, is heartbeat? %t&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;me&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;server&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;reply&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Success&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;reply&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Term&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;isHeartbeat&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
				&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;reply&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Term&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;currentTerm&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;// at this time we need to step down&lt;/span&gt;
					&lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;convertToFollower&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;reply&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Term&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
					&lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mu&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Unlock&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
					&lt;span class=&quot;k&quot;&gt;return&lt;/span&gt;
				&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

				&lt;span class=&quot;c&quot;&gt;// check if the condition still matches when we schedule the RPC&lt;/span&gt;
				&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;reply&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Term&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;currentTerm&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;state&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Leader&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
					&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;reply&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Success&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;true&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
						&lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;matchIndex&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;server&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;lastIdx&lt;/span&gt;
						&lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nextIndex&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;server&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;lastIdx&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;
					&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
						&lt;span class=&quot;c&quot;&gt;// need to do an optimization here&lt;/span&gt;
						&lt;span class=&quot;c&quot;&gt;// rf.nextIndex[server] = rf.nextIndex[server] - 1&lt;/span&gt;
						&lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nextIndex&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;server&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;updateNextIdx&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;reply&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
					&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
				&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

				&lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mu&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Unlock&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
				&lt;span class=&quot;k&quot;&gt;return&lt;/span&gt;
			&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
		&lt;span class=&quot;p&quot;&gt;}(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;peer&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;term&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;isHeartbeat&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;The key change is:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;We read the next index of the entry we need to send to follower &lt;em&gt;X&lt;/em&gt; from nextIndex, which is initiated inside the leader when it is voted. This records the next index of the entry we need to send to each follower. Leader initiated it to the last index + 1. All entries after the next index is the new entries we would love follower &lt;em&gt;X&lt;/em&gt; to replica&lt;/li&gt;
  &lt;li&gt;We also retrieve the pervious entry of the next index entry, send its index and term along the request&lt;/li&gt;
  &lt;li&gt;Upon receiving reply, we update the matchIndex and nextIndex accordingly. If request is rejected, we reduce the nextIndex of the follower &lt;em&gt;X&lt;/em&gt; by one, this is a linear search of the first entry in leaderâ€™s log that the follower &lt;em&gt;X&lt;/em&gt; would agree. However, in this assignment, it requires us to do some smarter search instead of linear search to speed up.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;The final piece of the logic is to create a thread to send replica to other servers. This is pretty similar to the thread that we periodically send heartbeats.&lt;/p&gt;

&lt;h2 id=&quot;commit-log-and-apply&quot;&gt;Commit Log and Apply&lt;/h2&gt;

&lt;p&gt;Another job we need to do is to commit log entries. The logic is done by the leader with the helper function &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;updateCommit&lt;/code&gt;. Similarly, we also create a dedicated thread to periodically call this helper function to see if we should advance the current commit index. The logic of &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;updateCommit&lt;/code&gt; is pretty simple, it just iterates all possible commit index and find the highest one that is qualified, which means that there are majority of serverâ€™s highest match index greater than it.&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-go&quot; data-lang=&quot;go&quot;&gt;&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Raft&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;updateCommit&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;c&quot;&gt;// DPrintf(&quot;leader %d, current match index %v, current commit index %d&quot;, rf.me, rf.matchIndex, rf.commitIndex)&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;newCommit&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;len&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;logEntries&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;newCommit&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;commitIndex&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;newCommit&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;commitCount&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;
		&lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;match&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;range&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;matchIndex&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
			&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;match&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;newCommit&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;logEntries&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;newCommit&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Term&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;currentTerm&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
				&lt;span class=&quot;n&quot;&gt;commitCount&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;
			&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
		&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
		&lt;span class=&quot;c&quot;&gt;// DPrintf(&quot;leader %d, current commit index %d, new commit index %d, commit count %d&quot;, rf.me, rf.commitIndex, newCommit, commitCount)&lt;/span&gt;
		&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;commitCount&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;len&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;matchIndex&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
			&lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;commitIndex&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;newCommit&lt;/span&gt;
			&lt;span class=&quot;k&quot;&gt;break&lt;/span&gt;
		&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Once the current commit index is updated, there is another thread working in background that going to apply the log entry from the current applied to the current commit index.&lt;/p&gt;

&lt;h2 id=&quot;snapshot&quot;&gt;Snapshot&lt;/h2&gt;

&lt;p&gt;In the final part of the Lab2, we are asked to add the functionality to persist state, which is the well known practice snapshot. According to the algorithm, there are in total three values need to be persisted: currentTerm, votedFor and log[]. Although we usually persist state to disk, in this lab we mimic this by using a dedicated class to encode and decode state. The change could be viewed &lt;a href=&quot;https://shorturl.at/A1278&quot;&gt;here&lt;/a&gt;. Anytime we make a change to the above 3 state, we would call the persist function to create a snapshot. When a raft server crashed, it would read the snapshot it has persisted and start to catch up others from there, instead of starting everything from the beginning, which could be pretty time consuming.&lt;/p&gt;

&lt;h2 id=&quot;future-work&quot;&gt;Future work&lt;/h2&gt;

&lt;p&gt;By this point, we have implemented the Raft algorithm E2E. Working on Raft has been one of the most challenging coding assignments I have ever had, especially debugging the abnormal behavior of the system. In the following lab, we are going to build other distributed system on top of the raft algorithm we have implemented here. Stay tuned!&lt;/p&gt;
</description>
        <pubDate>Sat, 10 Oct 2020 00:00:00 -0700</pubDate>
        <link>https://pyemma.github.io//Distributed-System-RAFT-II/</link>
        <guid isPermaLink="true">https://pyemma.github.io//Distributed-System-RAFT-II/</guid>
      </item>
    
      <item>
        <title>MIT Distributed System Course - Raft I</title>
        <description>&lt;h2 id=&quot;introduction&quot;&gt;Introduction&lt;/h2&gt;

&lt;p&gt;In the following series of post, we are going to implement Raft consensus algorithm, which is used to manage replicated log. And on top of that, we would implement a failure tolerance key-value store. This type of failure tolerant system is called replicated state machine. Replicated state machine operates on a collection of servers and makes them acting like a single server to the outside. The service would still be alive as long as majority of servers are still working.&lt;/p&gt;

&lt;h2 id=&quot;raft&quot;&gt;Raft&lt;/h2&gt;

&lt;p&gt;The original paper is available &lt;a href=&quot;https://raft.github.io/raft.pdf&quot;&gt;here&lt;/a&gt; and there is an official &lt;a href=&quot;https://raft.github.io/&quot;&gt;website&lt;/a&gt;. In this post, we would first introduce some basic concepts/abstractions in Raft. Then we would move to the Leader Election part, which is cover by the 5.1, 5.2 and 5.4 section in the original paper.&lt;/p&gt;

&lt;p&gt;The below figure in the original paper is a decent summarization of the Raft algorithm, which is recommend to read carefully words by words.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/raft.png&quot; alt=&quot;Summary of Raft consensus algorithm&quot; /&gt;&lt;/p&gt;

&lt;p&gt;There are several essential concepts in Raft&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Raft works on a group of machines, or servers, by managing a replicated log. Applications are built on top of these Raft servers.&lt;/li&gt;
  &lt;li&gt;There are in total 3 different state for Raft servers: &lt;strong&gt;follower&lt;/strong&gt;, &lt;strong&gt;candidate&lt;/strong&gt; and &lt;strong&gt;leader&lt;/strong&gt;.
    &lt;ul&gt;
      &lt;li&gt;The job for &lt;strong&gt;follower&lt;/strong&gt; is pretty simple, it responses to RPC call scheduled by &lt;strong&gt;candidate&lt;/strong&gt; or &lt;strong&gt;leader&lt;/strong&gt;.&lt;/li&gt;
      &lt;li&gt;The job for &lt;strong&gt;candidate&lt;/strong&gt; is to initiate leader election by voting itself and collecting votes from other servers.&lt;/li&gt;
      &lt;li&gt;The job for &lt;strong&gt;leader&lt;/strong&gt; is to replicate its log to &lt;strong&gt;follower&lt;/strong&gt; and send heartbeats to maintain its &lt;strong&gt;leader&lt;/strong&gt; state.&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;Raft use a sequence of &lt;strong&gt;term&lt;/strong&gt; to represent the entire process instead of using absolute time. Each &lt;strong&gt;term&lt;/strong&gt; is uniquely identified by a number, which is monotonically increasing.&lt;/li&gt;
  &lt;li&gt;Regarding to the lifetime of each &lt;strong&gt;term&lt;/strong&gt;, they all start with &lt;em&gt;leader election&lt;/em&gt;. Once a &lt;strong&gt;leader&lt;/strong&gt; is elected, the &lt;strong&gt;leader&lt;/strong&gt; repeatedly replicates its log onto all other servers, this process would continue as long as the &lt;strong&gt;leader&lt;/strong&gt; could still send heartbeats to all &lt;strong&gt;followers&lt;/strong&gt;. Otherwise, a new &lt;strong&gt;term&lt;/strong&gt; would start.&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;Term&lt;/strong&gt; number is passed during each RPC request and reply. It is used to identify if the request is from staled servers and reject their requests. This information is also used by staled servers to reset their status to the right one.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;For the leader election procedure, here are some highlights&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;As shown in the figure, we would have a RequestVote RPC to do the job. Within the RequestVote handler, we would check if the request is a legit one by comparing term number, term number of last entry and index number of last entry. This part is covered in section 5.4.1. It is mainly used for checking which server is more up to date.&lt;/li&gt;
  &lt;li&gt;If the request is smaller than the server, we would reject the vote. Otherwise, we would check if we have voted in the current term.&lt;/li&gt;
  &lt;li&gt;Once we grant vote, we would need to reset the election timeout.&lt;/li&gt;
  &lt;li&gt;Once election timeout is triggered. As long as the server is not &lt;strong&gt;leader&lt;/strong&gt;, it will first convert itself to &lt;strong&gt;candidate&lt;/strong&gt; state, vote for itself, reset election timeout and then start election.&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;Candidate&lt;/strong&gt; would send RequestVote RPC to all servers to collect votes in parallel and wait for response&lt;/li&gt;
  &lt;li&gt;There are 3 potential outcomes for leader election:
    &lt;ul&gt;
      &lt;li&gt;The &lt;strong&gt;candidate&lt;/strong&gt; collects majority of votes. It would convert itself to &lt;strong&gt;leader&lt;/strong&gt; and start to send heartbeats to all others.&lt;/li&gt;
      &lt;li&gt;The &lt;strong&gt;candidate&lt;/strong&gt; receives a heartbeat from other server that has &lt;strong&gt;term&lt;/strong&gt; not smaller than its term, it would convert itself to &lt;strong&gt;follower&lt;/strong&gt;.&lt;/li&gt;
      &lt;li&gt;The &lt;strong&gt;candidates&lt;/strong&gt; could not collect enough votes and in this case the term ended with no &lt;strong&gt;leader&lt;/strong&gt;. Election timeout would trigger and the &lt;strong&gt;candidate&lt;/strong&gt; would start an election with a new term.&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;The reason that &lt;strong&gt;candidates&lt;/strong&gt; could not get majority is due to â€œvote splitsâ€. Raft use randomization to avoid this issue as much as possible. During the init and reset of election timeout, we would generate a new random number instead of using some fixed one.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;strong&gt;Leader&lt;/strong&gt; would periodically send heartbeats to each server. It uses the AppendEntries RPC to do the job. By sending RPC request with an empty log, it means that this is a heartbeats. Once a follower receive a heartbeat, it would reset its election timeout.&lt;/p&gt;

&lt;h2 id=&quot;implementation&quot;&gt;Implementation&lt;/h2&gt;

&lt;p&gt;This is the first time that I work on concurrency programming and it is really challenging to get everything right. There are several suggestions on the &lt;a href=&quot;https://pdos.csail.mit.edu/6.824/labs/raft-structure.txt&quot;&gt;structure of Raft&lt;/a&gt; as well as how to &lt;a href=&quot;https://pdos.csail.mit.edu/6.824/labs/raft-locking.txt&quot;&gt;correctly use lock&lt;/a&gt;, which is super beneficial on understanding Raft behavior and the design. Below are some hints that I think is critical to get Raft correct:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;There are several long-running processes in Raft, such as sending heartbeats and monitoring election timeout. It is better to use some long-running threads(goroutines in Go) to do these jobs.&lt;/li&gt;
  &lt;li&gt;Since we need to send RPC in parallel, it is better to schedule the RPC calls within a thread and use a shared counters among these threads to collect the result.&lt;/li&gt;
  &lt;li&gt;Since we are sending each RPC within separate threads, we donâ€™t know when would the thread going to be executed and what would be the status of the server at that time. So it is critical for us to check if the &lt;em&gt;server still matches our assumption when we step into the function&lt;/em&gt;, such as if the term still matches or the state is still &lt;strong&gt;candidates&lt;/strong&gt; etc.&lt;/li&gt;
  &lt;li&gt;Avoid using lock around RPC calls, it is easy to cause dead lock.&lt;/li&gt;
  &lt;li&gt;Use â€œprint-to-consoleâ€ style debugging is pretty efficient actually. Log the event out and see if the server is behaving abnormally.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;The overall code is available &lt;a href=&quot;https://github.com/pyemma/mit-distributed-system/tree/master/src/raft&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;

&lt;h3 id=&quot;leader-election&quot;&gt;Leader election&lt;/h3&gt;

&lt;p&gt;For the leader election part, there are in total three pieces of work:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;RequestVote RPC handler&lt;/li&gt;
  &lt;li&gt;Function to start election for &lt;strong&gt;candidate&lt;/strong&gt;&lt;/li&gt;
  &lt;li&gt;Background thread to monitor election timeout and start election&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Here is the code of RequestVote RPC handler&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-go&quot; data-lang=&quot;go&quot;&gt;&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Raft&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;RequestVote&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;args&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;RequestVoteArgs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;reply&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;RequestVoteReply&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mu&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Lock&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;defer&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mu&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Unlock&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;DPrintf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;%d receive request vote from %d on term %d, current term %d&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;me&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;CandidateId&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Term&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;currentTerm&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

	&lt;span class=&quot;c&quot;&gt;// if candidate term is smaller than current term, directly reject&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Term&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;currentTerm&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;reply&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Term&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;currentTerm&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;reply&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;VoteGranted&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;false&lt;/span&gt;
		&lt;span class=&quot;k&quot;&gt;return&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
	&lt;span class=&quot;c&quot;&gt;// if candidate term is larger than current term, convert to follower first&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Term&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;currentTerm&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;convertToFollower&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Term&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

	&lt;span class=&quot;c&quot;&gt;// not vote or the vote is the same as pervious candidate&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;votedFor&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;||&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;votedFor&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;CandidateId&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;c&quot;&gt;// check if is more up to date&lt;/span&gt;
		&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;isCandidateUpdateToDate&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;false&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
			&lt;span class=&quot;n&quot;&gt;reply&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Term&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;currentTerm&lt;/span&gt;
			&lt;span class=&quot;n&quot;&gt;reply&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;VoteGranted&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;false&lt;/span&gt;
			&lt;span class=&quot;k&quot;&gt;return&lt;/span&gt;
		&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

		&lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;votedFor&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;CandidateId&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;// candidate is more up to date, vote for it&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;resetElectionTimer&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;        &lt;span class=&quot;c&quot;&gt;// whenever we make a vote, we need to reset the election timeout&lt;/span&gt;

		&lt;span class=&quot;n&quot;&gt;reply&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Term&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;currentTerm&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;reply&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;VoteGranted&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;true&lt;/span&gt;
		&lt;span class=&quot;k&quot;&gt;return&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

	&lt;span class=&quot;n&quot;&gt;reply&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Term&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;currentTerm&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;reply&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;VoteGranted&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;false&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;return&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;In the RequestVote handler, since we donâ€™t need to schedule any other RPC calls but change some shared variables, we acquire the lock from the entrance of the function. The first step is to check if the term in the request is outdated or not. If the term is outdated, then we directly reject the vote. Next step is to check if ourself is outdated or not. If our term is smaller, then we would immediately convert to &lt;strong&gt;follower&lt;/strong&gt;. This has no effect for a &lt;strong&gt;follower&lt;/strong&gt; but would make staled &lt;strong&gt;candidate&lt;/strong&gt; change to the correct status. When covert to &lt;strong&gt;follower&lt;/strong&gt;, we also reset the voted for variable. Although this step is not explicitly shown in the paper, this should be the correct behavior as we are in a new term and havenâ€™t vote for anyone yet.&lt;/p&gt;

&lt;p&gt;Then we check if the &lt;strong&gt;candidateâ€™s&lt;/strong&gt; logging is more up to date. This is described in section 5.4.1 as a restriction on the election. We put this part into a dedicated function below. The logic overall is exactly reproducing what the paper describes.&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-go&quot; data-lang=&quot;go&quot;&gt;&lt;span class=&quot;c&quot;&gt;// Check if the candidate is more up to date&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Raft&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;isCandidateUpdateToDate&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;args&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;RequestVoteArgs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;bool&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;len&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;logEntries&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;// there is some log entries on the server&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;myLastLogEntry&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;logEntries&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;len&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;logEntries&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
		&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;myLastLogEntry&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Term&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;LastLogTerm&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;||&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;myLastLogEntry&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Term&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;LastLogTerm&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;len&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;logEntries&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;LastLogIndex&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
			&lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;false&lt;/span&gt;
		&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;true&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Once we have voted for the candidate, we need to reset the election timeout. Here is the piece of code doing this job&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-go&quot; data-lang=&quot;go&quot;&gt;&lt;span class=&quot;c&quot;&gt;// Reset election timer&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Raft&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;resetElectionTimer&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;electionTime&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;time&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Now&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;electionTimeout&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;time&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Duration&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;rand&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Intn&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ElectionTimeOutRange&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ElectionTimeOutBase&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;time&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Millisecond&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;The way we implement timeout is to first record the start time and then regularly check if the current time minus the start time has exceed the timeout threshold or not. When we reset, we would use the current time to overwrite the start time, and assign a new timeout. This randomization is to help avoid split vote issues mentioned above.&lt;/p&gt;

&lt;p&gt;Once we have finished the RequestVote RPC handler part (the sending RPC function is pretty simple and we would skip it), we need to implement the function that &lt;strong&gt;candidates&lt;/strong&gt; use to start election. The entire logic is within the function &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;startElection&lt;/code&gt;. The overall logic of it could be separate into three part: change status, send rpc and collect vote. Letâ€™s breakdown the function and look at it step by step.&lt;/p&gt;

&lt;p&gt;The first part is to require the lock and update necessary status. The main logic is to change to &lt;strong&gt;candidate&lt;/strong&gt;, increase term and vote for itself.&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-go&quot; data-lang=&quot;go&quot;&gt;&lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mu&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Lock&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;DPrintf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;%d start election, pervious state %s&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;me&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;state&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;// change to candidate and increase term&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;currentTerm&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;++&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;state&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Candidate&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;votedFor&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;me&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;resetElectionTimer&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;// need to reset election timeout since we start a new election&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;// parameters to schedule RequestVote&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;term&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;currentTerm&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;lastLogTerm&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;  &lt;span class=&quot;c&quot;&gt;// placeholder&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;lastLogIndex&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;// placeholder&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mu&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Unlock&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;The next part is to send RPC calls to all servers. Since we are sending RPC calls here, we release the lock. We send each RPC within a goroutine. There are two important things to remember here:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Information about the status of the current server such as term, lastLogTerm are passed into the goroutines as parameters. The reason is that at this particular timestamp the server matches our criteria and we need to create a snapshot to record it for later check due to the fact that other concurrency threads might change the status before the goroutines actually got scheduled.&lt;/li&gt;
  &lt;li&gt;Similarly, we need to double check if the current status still matches our assumption when we start election. This is done by acquire the lock within the goroutine and compare the current status with the passed in status.&lt;/li&gt;
  &lt;li&gt;We user 2 parameters to record the total number of RPC finished and the number of votes we collected. We also use a cond as a signal to wake up the thread that is waiting on some conditions to be satisfied.&lt;/li&gt;
&lt;/ul&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-go&quot; data-lang=&quot;go&quot;&gt;&lt;span class=&quot;n&quot;&gt;cond&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sync&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;NewCond&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mu&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;count&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;// counter to check the number of vote&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;finished&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;// start send RequestVote in parallel&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;peer&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;range&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;peers&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;peer&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;me&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;continue&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;go&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;server&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;term&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;lastLogTerm&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;lastLogIndex&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mu&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Lock&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
        &lt;span class=&quot;c&quot;&gt;// server is still candidate and current term matches the term when we plan to request vote&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;state&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Candidate&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;||&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;currentTerm&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;term&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mu&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Unlock&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

        &lt;span class=&quot;n&quot;&gt;DPrintf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;%d send request vote to %d on term %d&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;me&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;server&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;currentTerm&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;args&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;RequestVoteArgs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;Term&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;         &lt;span class=&quot;n&quot;&gt;term&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;CandidateId&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;  &lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;me&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;LastLogTerm&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;  &lt;span class=&quot;n&quot;&gt;lastLogTerm&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;LastLogIndex&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;lastLogIndex&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

        &lt;span class=&quot;n&quot;&gt;reply&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;RequestVoteReply&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{}&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mu&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Unlock&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;

        &lt;span class=&quot;n&quot;&gt;ok&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sendRequestVote&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;server&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;reply&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

        &lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mu&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Lock&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;defer&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mu&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Unlock&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;finished&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;++&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ok&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;DPrintf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;%d got reply from %d on term %d with %t&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;me&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;server&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;currentTerm&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;reply&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;VoteGranted&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;reply&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Term&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;currentTerm&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
                &lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;convertToFollower&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;reply&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Term&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
                &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt;
            &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
            &lt;span class=&quot;c&quot;&gt;// vote is granted, and the term matches the current term, and server is still candidate&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;reply&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;VoteGranted&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;reply&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Term&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;currentTerm&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;state&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Candidate&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
                &lt;span class=&quot;n&quot;&gt;count&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;++&lt;/span&gt;
            &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;cond&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Broadcast&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;

    &lt;span class=&quot;p&quot;&gt;}(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;peer&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;term&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;lastLogTerm&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;lastLogIndex&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;The last part is to check if we have collected majority number of votes. If we havenâ€™t collect majority votes, or if the RPC call is not all finished yet, we would wait on the cond variable. This cond variable is also used in the goroutine we send RPC calls. The thread would be waked up in the goroutine when RPC call is finished, and the current thread would re-acquire the lock and check if the condition has matched or not. If we collect majority votes, we would convert to leader and start sending heartbeats.&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-go&quot; data-lang=&quot;go&quot;&gt;    &lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mu&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Lock&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
	&lt;span class=&quot;c&quot;&gt;// wait for enough vote or all request has returned&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;n&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;len&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;peers&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;majority&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;n&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;count&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;majority&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;finished&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;n&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;cond&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Wait&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

	&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;count&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;majority&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;DPrintf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;%d collect majority of votes&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;me&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
		&lt;span class=&quot;c&quot;&gt;// change to leader and send the initial batch of heartbeats&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;state&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Leader&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sendHeartbeat&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
		&lt;span class=&quot;k&quot;&gt;return&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mu&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Unlock&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;After we have a working function to start election, the next step, as well as the final part of leader election, is to have a background thread to periodically check the status of election timeout and trigger &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;startElection&lt;/code&gt; at the right time. We check if the current state is not &lt;strong&gt;leader&lt;/strong&gt; and if the time elapsed is greater than the timeout. If true then we start election, otherwise we would sleep 25ms and then check again.&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-go&quot; data-lang=&quot;go&quot;&gt;&lt;span class=&quot;k&quot;&gt;go&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mu&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Lock&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;killed&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mu&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Unlock&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;c&quot;&gt;// follower or candidate could start election upon election timeout&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;state&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Leader&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;time&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Now&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Sub&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;electionTime&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;electionTimeout&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mu&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Unlock&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;startElection&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mu&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Unlock&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;time&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Sleep&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;25&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;time&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Millisecond&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}()&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Above is all of the code related to leader election. Next, we would take a look at how heartbeats is implemented.&lt;/p&gt;

&lt;h3 id=&quot;heartbeats&quot;&gt;Heartbeats&lt;/h3&gt;

&lt;p&gt;Compared with leader election, heartbeat is relatively simple. Heartbeat is implemented via AppendEntries RPC call. This RPC call is used by &lt;strong&gt;leader&lt;/strong&gt; to send entires to &lt;strong&gt;followers&lt;/strong&gt; to update their log. If the entries sent is empty, then it would be a heartbeat signal, which its pure function is to reset &lt;strong&gt;followerâ€™s&lt;/strong&gt; election timeout so that the &lt;strong&gt;leader&lt;/strong&gt; could maintain its status.&lt;/p&gt;

&lt;p&gt;Similar to leader election, the work is also separated into 3 parts: AppendEntires RPC handler, function to send heartbeats and background thread to repeatedly send heartbeats.&lt;/p&gt;

&lt;p&gt;The AppendEntries RPC handler is pretty straight forward. It checks if the request is legal (a.k.a request term is not smaller than its current term) and covert itself to follower if its term is outdated. And then reset the election timeout.&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-go&quot; data-lang=&quot;go&quot;&gt;&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Raft&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;AppendEntries&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;args&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;AppendEntriesArgs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;reply&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;AppendEntriesReply&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;c&quot;&gt;// This is a heartbeat&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;len&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Entries&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mu&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Lock&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
		&lt;span class=&quot;k&quot;&gt;defer&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mu&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Unlock&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
		&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Term&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;currentTerm&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
			&lt;span class=&quot;n&quot;&gt;reply&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Term&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;currentTerm&lt;/span&gt;
			&lt;span class=&quot;n&quot;&gt;reply&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Success&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;false&lt;/span&gt;
			&lt;span class=&quot;k&quot;&gt;return&lt;/span&gt;
		&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

		&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Term&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;currentTerm&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
			&lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;convertToFollower&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Term&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
		&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Term&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;currentTerm&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;state&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Candidate&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
			&lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;convertToFollower&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Term&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
		&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

		&lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;resetElectionTimer&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;

		&lt;span class=&quot;n&quot;&gt;reply&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Term&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;currentTerm&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;reply&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Success&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;true&lt;/span&gt;
		&lt;span class=&quot;k&quot;&gt;return&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;The sending heartbeats part is also a simplified version of request votes and donâ€™t have too much to talk about. The background thread to periodically send heartbeats shares similar structure with the one to check election timeout.&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-go&quot; data-lang=&quot;go&quot;&gt;&lt;span class=&quot;k&quot;&gt;go&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mu&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Lock&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;killed&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mu&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Unlock&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;state&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Leader&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;time&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Now&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Sub&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;heartbeatTime&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;HeartbeatTimeout&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sendHeartbeat&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;rf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mu&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Unlock&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;time&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Sleep&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;10&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;time&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Millisecond&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}()&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;h2 id=&quot;future-work&quot;&gt;Future work&lt;/h2&gt;

&lt;p&gt;In the following posts, we would implement the AppendEntires RPC call to be able to replicate &lt;strong&gt;leaderâ€™s&lt;/strong&gt; log onto &lt;strong&gt;followers&lt;/strong&gt;.&lt;/p&gt;
</description>
        <pubDate>Sun, 09 Aug 2020 00:00:00 -0700</pubDate>
        <link>https://pyemma.github.io//Distributed-System-RAFT/</link>
        <guid isPermaLink="true">https://pyemma.github.io//Distributed-System-RAFT/</guid>
      </item>
    
      <item>
        <title>MIT Distributed System Course - MapReduce</title>
        <description>&lt;h2 id=&quot;introduction&quot;&gt;Introduction&lt;/h2&gt;

&lt;p&gt;This is going to be a series of posts to record my learning of &lt;a href=&quot;https://pdos.csail.mit.edu/6.824/schedule.html&quot;&gt;MIT 6.824 Distributed System&lt;/a&gt;. The post would focus on the course assignments which is to build some distributed systems from scratch using &lt;a href=&quot;https://golang.org/&quot;&gt;Go language&lt;/a&gt;. I would discuss some of the basic ideas that these assignments touched, as well as the reason I reached to the design decision of my implementation. For the code, here is some disclaimers:&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;The implementation would guaratee to pass the test script provided by the course&lt;/li&gt;
  &lt;li&gt;The implementation might not be in the most optimal status, I might have follow up posts to refactor the implementation later&lt;/li&gt;
  &lt;li&gt;The implementation might not be in the cleanest way, as Iâ€™m still learning Go language&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;mapreduce&quot;&gt;MapReduce&lt;/h2&gt;
&lt;p&gt;MapReduce has been known for a long time as a framework to handle large scale data processing jobs. &lt;strong&gt;&lt;em&gt;The first assignment is to build a simple version of MapReduce to do word count (a classic demo application for MapReduce xD)&lt;/em&gt;&lt;/strong&gt;.&lt;/p&gt;

&lt;p&gt;The original &lt;a href=&quot;https://pdos.csail.mit.edu/6.824/papers/mapreduce.pdf&quot;&gt;MapReduce paper&lt;/a&gt; includes lots of details about how it works overall and some tricks Google applied in their implementation. Here is a summary of some key points.&lt;/p&gt;

&lt;p&gt;There are two types of machines in the system:&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;Master: Coordinate the entire process, schedule Map/Reduce task to workers, store necessary metadata to track the progress of the process&lt;/li&gt;
  &lt;li&gt;Worker: Do the actual Map/Reduce task with usersâ€™ program&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;and there are two types of task:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Map: Read a split of data assigned and pass it to usersâ€™ map functions, generate intermediate key/value paris and store them in local files, propagate intermediate files to master&lt;/li&gt;
  &lt;li&gt;Reduce: Read all intermediate files according to some partition functions which distribute key/value pairs to different intermediate files, sort key/value pairs and pass to usersâ€™ reduce function, then output to final files&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;There are some tricks mentioned in the paper to improve the performance:&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;Locality, Map task is scheduled to the machine where the input splits stored. This helps save the precious network bandwidth.&lt;/li&gt;
  &lt;li&gt;Backup task is scheduled to resolve the straggler issue, which is the case that some workers are making progress unexpected slow.&lt;/li&gt;
  &lt;li&gt;Heartbeat is used by master to check the status of workers&lt;/li&gt;
  &lt;li&gt;If a worker failed, then all the Map task completed by the worker would be reset to idle. The Map task and Reduce task in progress would also be reset to idle.&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;implementation&quot;&gt;Implementation&lt;/h2&gt;

&lt;p&gt;The full implementation is available &lt;a href=&quot;https://github.com/pyemma/mit-distributed-system/tree/master/src/mr&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;

&lt;h3 id=&quot;rpc&quot;&gt;RPC&lt;/h3&gt;
&lt;p&gt;In this assignment, master and worker communicate via RPC calls. For example, a worker schedules a RPC call to master to get a task to work, and notifies master that the task has been finished via another RPC call. Here is a list of RPC in my implementation:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-go&quot; data-lang=&quot;go&quot;&gt;&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;m&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Master&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;RegisterWorkerId&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;args&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;RegisterWorkerIdArgs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;reply&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;RegisterWorkerIdReply&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;error&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;m&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Master&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;RequestJob&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;args&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;RequestJobArgs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;reply&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;RequestJobReply&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;error&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;m&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Master&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FinishJob&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;args&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FinishJobArgs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;reply&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FinishJobReply&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;error&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;RegisterWorkerId is the first RPC call each worker would schedule once up. This call is to register itself within masterâ€™s in memory status tracker so that master is aware of its existence and assigns it a unique identifer. The reason of this behavior is that master might need to reschedule a task to other workers if the original worker is a straggler. And the master need to use this identifier to check if the result is returned from the new worker instead of the staled work for the sake of security.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;RequestJob is a RPC call that workers call repeatedly. Master would assign a task for it if there is any task could be schedule to this worker or reply there is no available task. Once all tasks are done, a dedicated status would be returned to workers so that they could safely exits.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;FinishJob is a RPC call that workers call once the assigned work is done. Worker would also pass necessary information via this RPC call to master.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;master-record-data-structure&quot;&gt;Master Record Data Structure&lt;/h3&gt;

&lt;p&gt;As master is the coordinator for all workers, it is critical for master to keep track of all workersâ€™ progress. In this assignment, I highlight the following points for master to take care of:&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;Workers that are registered within the system and their identifiers.&lt;/li&gt;
  &lt;li&gt;Map/Reduce task identifiers. I made a simplification that, number of input files is tantamount to the number of map tasks. The number of reduce tasks is a parameter passed in once master is up.&lt;/li&gt;
  &lt;li&gt;Map/Reduce task status. There are in total 3 status: Not Scheduled/Pending/Done. If a task is in pending status, we would also record the worker id that is assigned with this task. This information is critical because the worker might fail or be straggle on the task. To avoid infinite waiting, master has a timeout of 10s on each task scheduled. So there might be cases that, some workers are straggle and would respond after 10s when master has already assigned the task to another worker. We would like to reject the response by this straggler worker. So only when the worker identifier matches masterâ€™s record, the response would be accepted.&lt;/li&gt;
  &lt;li&gt;Map task input filenames and intermediate filenames.&lt;/li&gt;
  &lt;li&gt;2 boolean parameters to check if all map tasks are done and all reduce tasks are done.&lt;/li&gt;
  &lt;li&gt;A mutex is used to lock the master data structure. The reason is that Go process each RPC call via treads and each tread is sharing the same copy of the record. To avoid racing condition, each thread needs to first acquire the lock and then does the necessary update.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Below is a piece of the code&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-go&quot; data-lang=&quot;go&quot;&gt;&lt;span class=&quot;k&quot;&gt;type&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Master&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;c&quot;&gt;// need to lock the object in concurrent env&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;mu&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sync&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Mutex&lt;/span&gt;
	&lt;span class=&quot;c&quot;&gt;// use an array to record all workers, we need to use this to reject&lt;/span&gt;
	&lt;span class=&quot;c&quot;&gt;// reply from workers that dead or straggle&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;workers&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[]&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt;
	&lt;span class=&quot;c&quot;&gt;// use a array here to store the mapper input filenames, this is&lt;/span&gt;
	&lt;span class=&quot;c&quot;&gt;// used to generate the mapper task id&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;mapperFilenames&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[]&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;string&lt;/span&gt;
	&lt;span class=&quot;c&quot;&gt;// use a dict here to store the status of mapper job&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;mapperStatus&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;map&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;JobStatus&lt;/span&gt;
	&lt;span class=&quot;c&quot;&gt;// use a map to store reducer input filenames&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;reducerFilenames&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;map&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;][]&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;string&lt;/span&gt;
	&lt;span class=&quot;c&quot;&gt;// use a dict here to store the status of reducer job&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;reducerStatus&lt;/span&gt;  &lt;span class=&quot;k&quot;&gt;map&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;JobStatus&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;numReducer&lt;/span&gt;     &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;mapperAllDone&lt;/span&gt;  &lt;span class=&quot;kt&quot;&gt;bool&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;reducerAllDone&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;bool&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;h3 id=&quot;master&quot;&gt;Master&lt;/h3&gt;

&lt;p&gt;Master implements the three RPC APIs mentioned in &lt;a href=&quot;#rpc&quot;&gt;RPC&lt;/a&gt;. I would skip RegisterWorkerId as it is pretty straight forward to implement and mainly focus on the RequestJob and FinishJob RPC call.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;&lt;strong&gt;&lt;em&gt;RequestJob&lt;/em&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;For RequestJob, all map tasks need to be done before the scheduling of any reduce task. The master would first lock the record, and see if there is any map task available. Once all map tasks are done, the corresponding flag would be enabled, and master would check if there is any available reduce task. Master would reply with a data type RequestJobReply.&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-go&quot; data-lang=&quot;go&quot;&gt;&lt;span class=&quot;k&quot;&gt;type&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;RequestJobReply&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;JobType&lt;/span&gt;    &lt;span class=&quot;kt&quot;&gt;string&lt;/span&gt;   &lt;span class=&quot;c&quot;&gt;// map/reduce job&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;JobId&lt;/span&gt;      &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt;      &lt;span class=&quot;c&quot;&gt;// map/reduce job id&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;Filenames&lt;/span&gt;  &lt;span class=&quot;p&quot;&gt;[]&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;string&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;// the input filename to map/reduce job&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;NumReducer&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt;      &lt;span class=&quot;c&quot;&gt;// number of reduce tasks in total&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;ul&gt;
  &lt;li&gt;JobType is to tell worker this is Map task or Reduce task.&lt;/li&gt;
  &lt;li&gt;JobId is the identifier assigned by master to track the jobâ€™s status.&lt;/li&gt;
  &lt;li&gt;Filenames could be the map input filenames or intermediate filenames generated by worker.&lt;/li&gt;
  &lt;li&gt;NumReducer is required to tell how many intermediate files we need to generate and shard the keys accordingly.&lt;/li&gt;
&lt;/ul&gt;

&lt;blockquote&gt;
  &lt;p&gt;&lt;strong&gt;&lt;em&gt;FinishJob&lt;/em&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;For FinishJob, master would read the result generated by workers and update the corresponding record. The logic of reduce task is pretty simple. For map task, master needs to parse the returned filenames and figures out the target reduce task id. For all map/reduce task, we need to check if the status is Pending and the worker id on record matches the worker id in the request before updating the record.&lt;/p&gt;

&lt;p&gt;Here is the structure of the FinishJob request, which is constructed by worker and send to master:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-go&quot; data-lang=&quot;go&quot;&gt;&lt;span class=&quot;k&quot;&gt;type&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FinishJobArgs&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;JobType&lt;/span&gt;   &lt;span class=&quot;kt&quot;&gt;string&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;JobId&lt;/span&gt;     &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;WorkerId&lt;/span&gt;  &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt;      &lt;span class=&quot;c&quot;&gt;// worker id&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;Filenames&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[]&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;string&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;// filenames that are generated&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Here is the logic of parsing filenames and updating the corresponding record:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-go&quot; data-lang=&quot;go&quot;&gt;&lt;span class=&quot;k&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Map&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;c&quot;&gt;// Mark the corresponding Map job finished, and flash the intermediate file&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;jobId&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;JobId&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;filenames&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Filenames&lt;/span&gt;
    &lt;span class=&quot;c&quot;&gt;// There might be duplicated job due to straggler, check the status to see if&lt;/span&gt;
    &lt;span class=&quot;c&quot;&gt;// the reply matches our record&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;jobStatus&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;m&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mapperStatus&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;jobId&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;jobStatus&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Status&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Pending&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;jobStatus&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;WorkerId&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;WorkerId&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;m&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mapperStatus&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;jobId&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;JobStatus&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Status&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Done&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;WorkerId&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;filename&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;range&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;filenames&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;token&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;strings&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Split&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;filename&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;-&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;reducerId&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;strconv&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ParseInt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;token&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;len&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;token&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;64&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;m&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;reducerFilenames&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;reducerId&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;append&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;m&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;reducerFilenames&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;reducerId&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)],&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;filename&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;blockquote&gt;
  &lt;p&gt;&lt;strong&gt;&lt;em&gt;CheckStatus&lt;/em&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;As mentioned in &lt;a href=&quot;#master-record-data-structure&quot;&gt;Master Record Data Structure&lt;/a&gt;, master has a timeout of 10s on each task scheduled. Once the task has been timeout, master would put the task back to Not Scheduled status so that it could be allocated to other workers, and clear the worker id on the record. This is achieved by firing a goroutines of func CheckStatus each time we schedule a task to a worker. Function CheckStatus would first sleep 10s and then check the status of the task. If the task is still in Pending status, then it would put it back to Not Scheduled status, otherwise it would directly return.&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-go&quot; data-lang=&quot;go&quot;&gt;&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;m&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Master&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;CheckStatus&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;jobType&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;jobId&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;time&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Sleep&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;time&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Second&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;m&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mu&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Lock&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;defer&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;m&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mu&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Unlock&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;jobType&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Map&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;jobStatus&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;m&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mapperStatus&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;jobId&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
		&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;jobStatus&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Status&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Done&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
			&lt;span class=&quot;n&quot;&gt;m&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mapperStatus&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;jobId&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;JobStatus&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Status&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;NotScheduled&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
		&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;jobStatus&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;m&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;reducerStatus&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;jobId&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
		&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;jobStatus&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Status&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Done&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
			&lt;span class=&quot;n&quot;&gt;m&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;reducerStatus&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;jobId&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;JobStatus&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Status&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;NotScheduled&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
		&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;h3 id=&quot;worker&quot;&gt;Worker&lt;/h3&gt;

&lt;p&gt;Worker takes userâ€™s customization map and reduce function as input. In this assignment, this is done via Go plug-ins. Once a worker is up, the first thing it tries to do is to call the RegisterWorkerId RPC to let the master know its existence and assign it an identifier. Each worker would have a unique identifier and this is guaranteed by the master. It then enters an infinite loop. Within the loop, the worker would try to first get a task from the master. Once it gets a map task:&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;Read in the file content&lt;/li&gt;
  &lt;li&gt;Pass all content into mapf function, which is the usersâ€™ map function&lt;/li&gt;
  &lt;li&gt;Shard the output according to the num of reduce tasks&lt;/li&gt;
  &lt;li&gt;Write all content into a temp file and then atomically rename it following the convention of &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;out-X-Y&lt;/code&gt;, where X is the map task id and Y is the reduce task id
    &lt;ul&gt;
      &lt;li&gt;The reason that we write into a temp file is that we donâ€™t want to expose any partially written file. Only when all content is flushed into the file, we would formally rename it to the acceptable intermediate filename.&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;Call FinishJob with the map task id, worker id and all intermediate filenames generated to the master&lt;/li&gt;
&lt;/ul&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-go&quot; data-lang=&quot;go&quot;&gt;&lt;span class=&quot;k&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Map&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;filename&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;reply&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Filenames&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;file&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;os&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Open&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;filename&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;content&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ioutil&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ReadAll&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;file&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;file&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Close&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;kva&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mapf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;filename&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;content&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;

    &lt;span class=&quot;c&quot;&gt;// shard the kv into nReducer splits&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;kvSharded&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;make&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;map&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;][]&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;KeyValue&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;kv&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;range&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;kva&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;shard&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ihash&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;kv&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Key&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;numReducer&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;kvSharded&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;shard&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;append&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;kvSharded&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;shard&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;kv&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;c&quot;&gt;// Flash the result to files&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;shard&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;kva&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;range&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;kvSharded&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;tempfile&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ioutil&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;TempFile&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;mr-tempfile&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;c&quot;&gt;// Use json format to store the result in intermeidate file&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;enc&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;json&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;NewEncoder&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tempfile&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;enc&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Encode&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;kva&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;tempfile&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Close&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;interFilename&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;mr-&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;strconv&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Itoa&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;reply&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;JobId&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;-&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;strconv&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Itoa&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;shard&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;  &lt;span class=&quot;c&quot;&gt;// mr-X-Y&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;os&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Rename&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tempfile&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Name&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(),&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;interFilename&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;intermediate&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;append&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;intermediate&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;interFilename&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;FinishJob&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;workerId&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;reply&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;JobType&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;reply&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;JobId&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;intermediate&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Once it gets a reduce task:&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;Read all intermediate files content&lt;/li&gt;
  &lt;li&gt;Sort all keys&lt;/li&gt;
  &lt;li&gt;Pass to reducef. This part of logic is provided by the assignment example&lt;/li&gt;
  &lt;li&gt;Flush result into temp file and once everything is done rename it to &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;out-X&lt;/code&gt; where X is the reduce task id&lt;/li&gt;
&lt;/ul&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-go&quot; data-lang=&quot;go&quot;&gt;&lt;span class=&quot;k&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Reduce&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;c&quot;&gt;// Read values from all intermediate file&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;kva&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;make&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;([]&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;KeyValue&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;filename&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;range&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;reply&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Filenames&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;file&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;os&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Open&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;filename&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;dec&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;json&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;NewDecoder&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;file&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;kvs&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;make&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;([]&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;KeyValue&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;err&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;dec&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Decode&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;kvs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;err&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;nil&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Fatalf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;fail to read intermediate file&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;kva&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;append&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;kva&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;kvs&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;...&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;n&quot;&gt;sort&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Sort&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ByKey&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;kva&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;

    &lt;span class=&quot;n&quot;&gt;oname&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;mr-out-&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;strconv&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Itoa&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;reply&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;JobId&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;tempfile&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ioutil&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;TempFile&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;mr-tempfile&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;c&quot;&gt;// This part of code is copied from the course example code&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;len&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;kva&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;j&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;j&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;len&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;kva&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;kva&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;j&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Key&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;kva&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Key&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;j&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;++&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;values&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[]&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{}&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;k&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;k&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;j&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;++&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;values&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;append&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;values&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;kva&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Value&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;output&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;reducef&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;kva&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Key&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;values&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

        &lt;span class=&quot;n&quot;&gt;fmt&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Fprintf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tempfile&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;%v %v&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;kva&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Key&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;output&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

        &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;j&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;tempfile&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Close&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;os&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Rename&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tempfile&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Name&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(),&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;oname&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;intermediate&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;append&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;intermediate&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;oname&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

    &lt;span class=&quot;n&quot;&gt;FinishJob&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;workerId&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;reply&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;JobType&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;reply&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;JobId&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;intermediate&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Once the worker receives None flag from RequestJob response, it would sleep for 2s and then continues. Once it receives AllDone, it would break the loop and exit.&lt;/p&gt;

&lt;h2 id=&quot;future-plan&quot;&gt;Future Plan&lt;/h2&gt;

&lt;p&gt;This is just a naive implementation and there are several points that could be optimized.&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;The master data structure could be simplified, e.g.
    &lt;ul&gt;
      &lt;li&gt;Map/Reduce task status could be merged into a single one&lt;/li&gt;
      &lt;li&gt;We could keep a queue to check if there are still map/reduce tasks not scheduled yet&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;The logic within workerâ€™s map/reduce processing could be optimized, e.g.
    &lt;ul&gt;
      &lt;li&gt;When we write and read intermediate file, we are processing sequentially. But we could actually do this concurrently by splitting the work of each intermediate file into a goroutine&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Please leave any comment and feedback you have :)&lt;/p&gt;
</description>
        <pubDate>Sat, 25 Jul 2020 00:00:00 -0700</pubDate>
        <link>https://pyemma.github.io//Distributed-System-Map-Reduce/</link>
        <guid isPermaLink="true">https://pyemma.github.io//Distributed-System-Map-Reduce/</guid>
      </item>
    
      <item>
        <title>DQN In Practice</title>
        <description>&lt;p&gt;Recently I have been working on Deep-Q-Learning and apply it to some interesting AI games. In this post, I would like to give a brief introduction to how I implemented the Deep-Q-Learning, as well as lots of learning along the way.&lt;/p&gt;

&lt;h3 id=&quot;what-is-dqn&quot;&gt;What is DQN&lt;/h3&gt;
&lt;p&gt;To understand DQN, we need first know is prototype, Q-Leanring. Here is a pervious post about &lt;a href=&quot;https://pyemma.github.io/Reinforcement-Learning-Lesson-4/&quot;&gt;Q-Learning&lt;/a&gt;. Some core elements are:&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;We have a \( Q(s, a) \) to record for each state and action pair, what is the expected reward we can get from them&lt;/li&gt;
  &lt;li&gt;We update this estimation by finding what is the &lt;strong&gt;max&lt;/strong&gt; reward we can get from the next state leaded by our current state and action, update it by \(Q(S, A) = Q(S, A) + \alpha(R + \gamma max_a Q(S^\prime, a) - Q(S, A))\)&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;If we have limited number of state and action, we can hold these information into a simple lookup table. However, in reality we usually deal with unlimited number of state and action. In this case, a lookup table is not scalable, we use a model to simulate this part: describe the state with some features, tell the model and the model will tell us what \( Q(s, a) \) would be, the model would be trained and updated along the way with the examples we have.&lt;/p&gt;

&lt;p&gt;Deep-Q-Leanring basically is a combination of the above two ideas. Apply the logic of Q-Learning, with a model measuring the \( Q(s, a) \). Here the &lt;em&gt;Deep&lt;/em&gt; comes from the fact that we usually use &lt;em&gt;Deep-Neural-Network&lt;/em&gt; as our model. However, there is another two important thing to stabilize the training of DQN:&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;&lt;strong&gt;Experience Replay&lt;/strong&gt;: Instead of directly using the most recent example, we keep a pool of past experience and sample a batch from this pool to update our model&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;Q-Target Network&lt;/strong&gt;: Instead of the max value output by our current model, we use the version of several steps ago. This is called the Q-Target model and this model will be frozen and not updated, but occasionally copied from our main model.&lt;/li&gt;
&lt;/ol&gt;

&lt;h3 id=&quot;dqn-implementation&quot;&gt;DQN Implementation&lt;/h3&gt;
&lt;p&gt;Cool, as we have some highlight idea on what DQN is, letâ€™s see how it is implemented. The code is &lt;a href=&quot;https://github.com/pyemma/tensorflow/blob/master/util/dqn.py&quot;&gt;here&lt;/a&gt;. Please not that this code is currently not generalized yet and only suitable for training &lt;em&gt;Cartpole&lt;/em&gt; game due to how we parsing the state. Making it generalized is WIP. However, that does not prevent us from understanding the main idea of DQN. Let me now illustrate some important component:&lt;/p&gt;

&lt;p&gt;Letâ€™s first take a look at the main training logic:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-python&quot; data-lang=&quot;python&quot;&gt;&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;train&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;bp&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;epsiode&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;):&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;&quot;&quot;&quot;Train the model
    Args:
        epsiode:        Number of epsiode to train
    &quot;&quot;&quot;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;epsilon&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;bp&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;epsilon_start&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ep&lt;/span&gt; &lt;span class=&quot;ow&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;range&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;epsiode&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;):&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;state&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;bp&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;env&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;reset&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;done&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;bp&quot;&gt;False&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;ow&quot;&gt;not&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;done&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;action&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;bp&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;_action&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;bp&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;_norm&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;state&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;epsilon&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;next_state&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;reward&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;done&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;bp&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;env&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;step&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;action&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;reward&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;100&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;done&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.1&lt;/span&gt;
            &lt;span class=&quot;bp&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;_remember&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;state&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;action&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;reward&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;next_state&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;done&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;state&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;next_state&lt;/span&gt;

        &lt;span class=&quot;bp&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;_learn&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;

        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ep&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&lt;/span&gt; &lt;span class=&quot;bp&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;step_to_copy_graph&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;bp&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;_copy_graph&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;

        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;epsilon&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;bp&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;epsilon_end&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;epsilon&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*=&lt;/span&gt; &lt;span class=&quot;bp&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;epsilon_decay&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;For each episode, we first initialize the state, and before the game terminate, we take a action based on our model and policy, then get the reward and next state for that action. We then put this as an experience into our memory pool. After the game is terminated, we update our model, and check if we should update q-target network. We also decrease the epsilon as we play. Here we are using \( \epsilon \)-greedy policy, and this parameter is the tradeoff between explore and exploit.&lt;/p&gt;

&lt;p&gt;Now lets take a look at how we train the model:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-python&quot; data-lang=&quot;python&quot;&gt;&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;_learn&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;bp&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;):&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;&quot;&quot;&quot;Use Experience Replay and Target Value Network to learn
    &quot;&quot;&quot;&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;len&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;bp&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;memory&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;bp&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;batch_size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;sample_idx&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;np&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;random&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;choice&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;min&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;len&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;bp&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;memory&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;bp&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;memory_size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;bp&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;batch_size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;samples&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;bp&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;memory&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;idx&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;idx&lt;/span&gt; &lt;span class=&quot;ow&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sample_idx&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;

    &lt;span class=&quot;n&quot;&gt;q_X&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;target_X&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;actions&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rewards&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;dones&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[],&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[],&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[],&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[],&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[]&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;state&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;action&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;reward&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;next_state&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;done&lt;/span&gt; &lt;span class=&quot;ow&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;samples&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;q_X&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;append&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;state&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;target_X&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;append&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;next_state&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;actions&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;append&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;action&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;rewards&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;append&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;reward&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;dones&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;append&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;done&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

    &lt;span class=&quot;n&quot;&gt;q_labels&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;target_labels&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;bp&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;q_model&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;predict&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;bp&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sess&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;np&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;array&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;q_X&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)),&lt;/span&gt; &lt;span class=&quot;bp&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;target_model&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;predict&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;bp&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sess&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;np&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;array&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;target_X&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;q_target&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;q_labels&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;copy&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;q_target&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;np&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;arange&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;bp&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;batch_size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;np&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;array&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;actions&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;np&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;array&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;rewards&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;bp&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;gamma&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;np&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;max&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;target_labels&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;axis&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;np&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;array&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;dones&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;

    &lt;span class=&quot;bp&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;q_model&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;update&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;bp&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sess&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;np&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;array&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;q_X&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;q_target&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Here, we sample a batch of experience from our memory pool. Then prepare it into the right format. Our goal is to train our modelâ€™s prediction (in this case, the prediction is the value of each action) is the same as the actual reward + q-target. In the code, we first get the model prediction for all actions. We also get q-target prediction for each action. We then update the value for the action we take to the target value. Then we train our model using this updated value. Since we only updated the value of action we took, the model will only learn from these updated value, all other is the same as before and model would not learn from them.&lt;/p&gt;

&lt;h3 id=&quot;dqn-in-practice&quot;&gt;DQN In Practice&lt;/h3&gt;
&lt;p&gt;During the implementation of this feature, I encountered lots of problem and would like to notice them down for further discussion:&lt;/p&gt;
&lt;ol&gt;
  &lt;li&gt;Initially I updated the model &lt;strong&gt;after we take each action&lt;/strong&gt; instead of &lt;strong&gt;after each game&lt;/strong&gt;. This will dramatically increase the number of training we have and impact on the training time. However, getting more number of training is not always a good thing. I noticed that in my case, the training would be not stable.&lt;/li&gt;
  &lt;li&gt;Parameter tuning is really challenging. I tried different combination of batch size, memory pool size, learning rate, and model arch. I found that usually have a moderate memory pool size with a larger learning rate is beneficial.&lt;/li&gt;
  &lt;li&gt;The step to copy the q-target network is also hard to set. If we set is too small, then the training is less stabile; if too large, the training does not get improved.&lt;/li&gt;
  &lt;li&gt;I feel like the usage of the memory is not good enough, as there is not difference in terms of success experience and failure experience. From our common sense, we know that we learn more from our bad experience, maybe we should skew more onto the bad experience?&lt;/li&gt;
&lt;/ol&gt;
</description>
        <pubDate>Sat, 27 Jan 2018 00:00:00 -0800</pubDate>
        <link>https://pyemma.github.io//DQN-In-Practice/</link>
        <guid isPermaLink="true">https://pyemma.github.io//DQN-In-Practice/</guid>
      </item>
    
      <item>
        <title>Reinforcement Learning Lesson 8</title>
        <description>&lt;p&gt;This is the last lesson for the entire reinforcement learning, and in this lesson we will learn something related to exploit and explore. In machine learning service, like recommendation service, there is always a trade off between exploit and explore. Exploit means we are always choosing the best given the current information we have, while explore means try something new we havenâ€™t tried yet. An example is if you go to restaurant, you can always go to the one you enjoy most(exploit), while you can also try a new one(explore).&lt;/p&gt;

&lt;p&gt;This problem is usually formularized as multi bandit problem, which can be represented as \(&amp;lt;A, R&amp;gt; \). Here \( A \) is a set of action we can take, and \( R^a(r) = P[R=r, A=a] \) is an &lt;strong&gt;unknown&lt;/strong&gt; probability distribution over rewards. At each time, our agent is going to pick an action, and the environment will generate a reward. The goal is to maximize the cumulative reward.&lt;/p&gt;

&lt;h4 id=&quot;regret&quot;&gt;Regret&lt;/h4&gt;
&lt;p&gt;We can measure the goodness of our action use &lt;strong&gt;regret&lt;/strong&gt;. Suppose the action value is the mean reward for an action \( a \)&lt;/p&gt;

\[Q(a) = E[r|a]\]

&lt;p&gt;and the optimal value \( V^\star \) is the max mean reward we can get&lt;/p&gt;

\[V^\star = Q(a^\star) = max_{a\in A}Q(a)\]

&lt;p&gt;Then maximize the cumulative reward is equivalent to minimize the total regret, which is&lt;/p&gt;

\[L_t = E[\sum_{i=1}^t (V^\star - Q(a_i))]\]

&lt;h4 id=&quot;upper-confidence-bound&quot;&gt;Upper Confidence Bound&lt;/h4&gt;
&lt;p&gt;We can try to solve this problem in the face of uncertainty. The best action we should try is the one that would on one hand has a high mean reward, and on the other hand have a high uncertainty. We might get a higher reward, which is good. While we can also get a worse reward, but that does not matter, since we can reduce our uncertainty about that action, and prefer other action which might have higher reward. A more formal description is as follow:&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;Estimate an upper confidence \( \hat{U_t}(a) \) for each action value, which depends on the number of times \( a \) has been selected, the larger the times, the smaller the upper confidence&lt;/li&gt;
  &lt;li&gt;Such that \( Q(a) \le \hat{Q_t}(a) + \hat{U_t}(a) \) with high probability&lt;/li&gt;
  &lt;li&gt;Select action maximize Upper Confidence Bound (UCB)&lt;/li&gt;
&lt;/ul&gt;

\[a_t = argmax_{a\in A} \hat{Q_t}(a) + \hat{U_t}(a)\]

&lt;p&gt;We need to come up with some method to calculate the upper bound. Here, we bring &lt;em&gt;Hoeffdingâ€™s Inequality&lt;/em&gt; for help&lt;/p&gt;
&lt;blockquote&gt;
  &lt;p&gt;Let \( X_1,â€¦, X_t \) be i.i.d. random variables in \( [0, 1] \), and let \( \bar{X_t} = \frac{1}{i} \sum_{i=1}^t X_i \) be the sample mean. Then&lt;/p&gt;
&lt;/blockquote&gt;

\[P[E[X] &amp;gt; \bar{X}_t + u] \le e^{-2tu^2}\]

&lt;p&gt;With this we can have&lt;/p&gt;

\[P[Q(a) &amp;gt; \hat{Q_t}(a) + \hat{U_t}] \le e^{-2N_t(a)U_t(a)^2}\]

&lt;p&gt;where \( N_t(a) \) is the expected number of \( a \) is selected. We then can pick a probability \( p \) that true value exceeds UCB, and reduce $p$ as we observer more rewards, e.g. \( p = t^{-4} \). Then we could obtain the upper bound as:&lt;/p&gt;

\[U_t(a) = \sqrt{\frac{2logt}{N_t(a)}}\]

&lt;p&gt;And finally we have the UCB1 algorithm&lt;/p&gt;

\[a_t = argmax_{a\in A} (Q(a) + \sqrt{\frac{2logt}{N_t(a)}})\]
</description>
        <pubDate>Wed, 13 Sep 2017 00:00:00 -0700</pubDate>
        <link>https://pyemma.github.io//Reinforcement-Learning-Lesson-8/</link>
        <guid isPermaLink="true">https://pyemma.github.io//Reinforcement-Learning-Lesson-8/</guid>
      </item>
    
      <item>
        <title>Reinforcement Learning Lesson 7</title>
        <description>&lt;p&gt;In the pervious notes, we are all using &lt;strong&gt;model-free&lt;/strong&gt; reinforcement learning method to find the solution for the problem. Today we are going to introduce method that directly learns from the experience and tries to understand the underlaying world.&lt;/p&gt;

&lt;p&gt;From &lt;a href=&quot;http://pyemma.github.io/posts/Reinforcement-Learning-Lesson-1&quot;&gt;Lesson 1&lt;/a&gt; we know that a MDP can be represent by \( &amp;lt;S, A, P, R&amp;gt; \), and our model is going to understand and simulate this. We will only introduce the simple version here, in which we assume that the \( S \) and \( A \) is known, and thus we only need to model \( P \) and \( R \). We can formulate it as:&lt;/p&gt;

\[S_{t+1} ~ P_\eta(S_{t+1}|S_t, A_t) \\
R_{t+1} = R_\eta(R_{t+1}|S_t, A_t)\]

&lt;p&gt;where the prediction of next state is a density estimation problem and the reward is a regression problem.&lt;/p&gt;

&lt;h2 id=&quot;integrated-architecture&quot;&gt;Integrated Architecture&lt;/h2&gt;
&lt;p&gt;In this architecture, we are going to consider two types of experience. &lt;strong&gt;Real experience&lt;/strong&gt; which is sampled from the environment, and &lt;strong&gt;Simulated experience&lt;/strong&gt; which is sampled from our model. In the past, we only use the real experience to learn value function/policy. Now, we are going to learn our model from real experience, then plan and learn value function/policy from both real and simulated experience. This is thus called integrated architecture (integration of real and fake), the &lt;strong&gt;Dyna Architecture&lt;/strong&gt;. Here is an picture to illustrate what the logic flow of Dyna is like.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/dyna.png&quot; alt=&quot;Dyna Architecture&quot; /&gt;&lt;/p&gt;

&lt;p&gt;According to the Dyna architecture, we can design many algorithm, here is an example of &lt;strong&gt;Dyna-Q Algorithm&lt;/strong&gt;:&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;Initialize \( Q(s, a) \) and \( Model(s, a) \) for all \( s \) and \( a \)&lt;/li&gt;
  &lt;li&gt;Do forever:
    &lt;ul&gt;
      &lt;li&gt;\( S = \) current (nonterminal) state&lt;/li&gt;
      &lt;li&gt;\( A = \epsilon - \text{greedy}(S, Q) \)&lt;/li&gt;
      &lt;li&gt;Execute action \( A \); observe result reward \( R \), and state \( Sâ€™ \)&lt;/li&gt;
      &lt;li&gt;\( Q(S, A) = Q(S, A) + \alpha[R + \gamma max_a Q(Sâ€™, a) - Q(S, A)] \) (This is using real experience)&lt;/li&gt;
      &lt;li&gt;Update \( Model(S, A) \) using \( R, Sâ€™ \)&lt;/li&gt;
      &lt;li&gt;Repeat \( n \) times: (This is using simulated experience to learn value function)
        &lt;ul&gt;
          &lt;li&gt;\( S = \) random previously observed state&lt;/li&gt;
          &lt;li&gt;\( A = \) random action previously taken in \( S \)&lt;/li&gt;
          &lt;li&gt;Sample \( R, Sâ€™ \) from \( Model(S, A) \)&lt;/li&gt;
          &lt;li&gt;\( Q(S, A) = Q(S, A) + \alpha[R + \gamma max_a Q(Sâ€™, a) - Q(S, A)] \)&lt;/li&gt;
        &lt;/ul&gt;
      &lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;monte-carlo-tree-search&quot;&gt;Monte-Carlo Tree Search&lt;/h2&gt;
&lt;p&gt;&lt;strong&gt;Monte-Carlo Tree Search&lt;/strong&gt; is a very efficient algorithm to plan once we have a model.&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;Given a model \( M_v \)&lt;/li&gt;
  &lt;li&gt;Simulate $K$ episodes from current state $s_t$ using current simulation policy \( \pi \)&lt;/li&gt;
&lt;/ul&gt;

\[{s_t, A_t^k, R_{t+1}^k, S_{t+1}^k, ..., S_T^k} ~ M_v, \pi\]

&lt;ul&gt;
  &lt;li&gt;Build a search tree containing visited states and actions&lt;/li&gt;
  &lt;li&gt;Evaluate state \( Q(s, a) \) by mean return of episodes from \( s, a \)&lt;/li&gt;
  &lt;li&gt;After search is finished, select current (real) action with maximum value in search tree&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;In MCMT, the simulation policy \( \pi \) improves. Each simulation consists of two phases (in-tree, out-of-tree):&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;Tree policy (improves): pick action to maximize \( Q(S, A) \)&lt;/li&gt;
  &lt;li&gt;Default policy (fixed): pick action randomly&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Repeat (each simulation):&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;Evaluate states \( Q(S, A) \) by Mento-Carlo evaluation&lt;/li&gt;
  &lt;li&gt;Improve tree policy, e.g. by \( \epsilon-\text{greedy}(Q) \)s&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;There are several advantages of MCMT:&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;Highly selective best-first search&lt;/li&gt;
  &lt;li&gt;Evaluates states dynamically&lt;/li&gt;
  &lt;li&gt;Uses sampling to break curse of dimensionality&lt;/li&gt;
  &lt;li&gt;Works for â€œblack-boxâ€ models (only requires samples)&lt;/li&gt;
  &lt;li&gt;Computationally efficient, anytime&lt;/li&gt;
&lt;/ul&gt;
</description>
        <pubDate>Mon, 11 Sep 2017 00:00:00 -0700</pubDate>
        <link>https://pyemma.github.io//Reinforcement-Learning-Lesson-7/</link>
        <guid isPermaLink="true">https://pyemma.github.io//Reinforcement-Learning-Lesson-7/</guid>
      </item>
    
      <item>
        <title>Reinforcement Learning Lesson 6</title>
        <description>&lt;p&gt;In the pervious we use a model to approximate the state value/action value function. In this post, we are going to learn how to directly parameterize a policy, which means we would directly get the probability of each action given a state:&lt;/p&gt;

\[\pi_{\theta}(s ,a) = P[a|s, \theta]\]

&lt;p&gt;In this case, we are not going to have any value function. A slight variance of this method is called &lt;strong&gt;Actor-Critic&lt;/strong&gt;, in which both value function and policy are modeled and learnt.&lt;/p&gt;

&lt;p&gt;The advantage of &lt;strong&gt;Policy based RL&lt;/strong&gt; is:&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;Better convergence properties&lt;/li&gt;
  &lt;li&gt;Effective in high-dimensional or continuous action spaces&lt;/li&gt;
  &lt;li&gt;Can learn stochastic policies&lt;/li&gt;
&lt;/ul&gt;

&lt;h4 id=&quot;policy-objective-functions&quot;&gt;Policy Objective Functions&lt;/h4&gt;
&lt;p&gt;Since we are going to learn \( \pi_\theta (s, a) \) and find the best \( \theta \), we need to first find a way to measure the quality of our policy. These are called &lt;strong&gt;policy objective function&lt;/strong&gt; and some we can use are:&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;In episode environment we can use the start value&lt;/li&gt;
&lt;/ul&gt;

\[J_1(\theta) = V^{\pi_\theta}(s_1) = E_{\pi_\theta}[v_1]\]

&lt;ul&gt;
  &lt;li&gt;In continuous environment we can use average value or average reward pre time-step&lt;/li&gt;
&lt;/ul&gt;

\[J_{avV}(\theta) = \sum_{s}d^{\pi_\theta}(s)V^{\pi_\theta}(s) \\
J_{avR}(\theta) = \sum_{s}d^{\pi_\theta}(s)\sum_{a}\pi_\theta(s, a)R_s^a\]

&lt;p&gt;where \( d^{\pi_\theta}(s) \) is stationary distribution of Markov chain for \( \pi_\theta \).&lt;/p&gt;

&lt;p&gt;After we have the measurement of the policy quality, we are going to find the best parameter which gives us the best quality and this becomes an optimization problem. Actually, similar to the last post, we can also use stochastic gradient to help use here. Since we are trying to find the maximum value, we are going to use what is called gradient ascent to find the steepest direction to update our parameter (very similar to gradient decrease).&lt;/p&gt;

&lt;h4 id=&quot;score-function&quot;&gt;Score Function&lt;/h4&gt;
&lt;p&gt;In order to compute the policy gradient analytically, we introduced the &lt;strong&gt;score function&lt;/strong&gt;. Assume policy $\pi_{\theta}$ is differentiable whenever it is non-zero and we know the gradient $\nabla_\theta \pi_\theta (s, a)$. Then using some tricky we have:&lt;/p&gt;

\[\begin{align}
\nabla_\theta \pi_\theta (s, a) &amp;amp; = \pi_\theta (s, a) \frac{\nabla_\theta \pi_\theta (s, a) }{\pi_\theta (s, a)} \\
&amp;amp; = \pi_\theta (s, a) \nabla_\theta log \pi_\theta (s, a)
\end{align}\]

&lt;p&gt;Here, $\nabla_\theta log \pi_\theta (s, a)$ is the &lt;strong&gt;score function&lt;/strong&gt;.&lt;/p&gt;

&lt;h4 id=&quot;policy-gradient-theorem&quot;&gt;Policy Gradient Theorem&lt;/h4&gt;
&lt;blockquote&gt;
  &lt;p&gt;For any differentiable policy $\pi_\theta (s, a)$, for any of the policy objective functions $J_1, J_{avV}, J_{avR}$, the policy gradient is&lt;/p&gt;
&lt;/blockquote&gt;

\[\nabla_\theta J(\theta) = E_{\pi_\theta}[\nabla_\theta log \pi_\theta (s, a) Q^{\pi_\theta} (s, a)]\]

&lt;h4 id=&quot;monte-carlo-policy-gradient&quot;&gt;Monte-Carlo Policy Gradient&lt;/h4&gt;
&lt;p&gt;Use return as an unbiased sample of $Q^{\pi_\theta} (s, a)$, the algorithm is as follow:&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;Initialize $\theta$ arbitrarily
    &lt;ul&gt;
      &lt;li&gt;for each episode ${s_1, a_1, r_2, â€¦, s_{T-1}, a_{T-1}, r_T} ~ \pi_\theta$ do
        &lt;ul&gt;
          &lt;li&gt;for $t = 1$ to $T - 1$ do
            &lt;ul&gt;
              &lt;li&gt;$\theta = \theta + \alpha \nabla_\theta log \pi_\theta (s, a) v_t$&lt;/li&gt;
            &lt;/ul&gt;
          &lt;/li&gt;
          &lt;li&gt;end for&lt;/li&gt;
        &lt;/ul&gt;
      &lt;/li&gt;
      &lt;li&gt;end for&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;return $\theta$&lt;/li&gt;
&lt;/ul&gt;

&lt;h4 id=&quot;actor-critic-policy-gradient&quot;&gt;Actor Critic Policy Gradient&lt;/h4&gt;
&lt;p&gt;The problem with Monte-Carlo Policy Gradient is that is has a very high variance. In order to reduce the variance, we can use a &lt;strong&gt;critic&lt;/strong&gt; to estimate the action value function. Thus in &lt;strong&gt;Actor Critic Policy Gradient&lt;/strong&gt;, we have two components:&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;&lt;em&gt;Critic&lt;/em&gt; updates action value function parameters $w$&lt;/li&gt;
  &lt;li&gt;&lt;em&gt;Actor&lt;/em&gt; updates policy parameters $\theta$, in direction suggested by critic&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Here is an example when we use linear value function approximation for the critic:&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;Initialize $s$, $\theta$&lt;/li&gt;
  &lt;li&gt;Sample $a ~ \pi_\theta$&lt;/li&gt;
  &lt;li&gt;for each step do
    &lt;ul&gt;
      &lt;li&gt;Sample reward $r$, sample next state $sâ€™$&lt;/li&gt;
      &lt;li&gt;Sample action $aâ€™ ~ \pi_\theta (sâ€™, aâ€™)$&lt;/li&gt;
      &lt;li&gt;$\delta = r + \gamma Q_w(sâ€™, aâ€™) - Q_w(s, a)$ (This is the TD error)&lt;/li&gt;
      &lt;li&gt;$\theta = \theta + \alpha \nabla_\theta log \pi_\theta (s, a) Q_w(s, a)$ (We replace with the approximation)&lt;/li&gt;
      &lt;li&gt;$w = w + \beta \delta \phi(s, a)$ (Update value function approximation model parameter)&lt;/li&gt;
      &lt;li&gt;$a = aâ€™$, $s = sâ€™$&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;end for&lt;/li&gt;
&lt;/ul&gt;
</description>
        <pubDate>Sun, 10 Sep 2017 00:00:00 -0700</pubDate>
        <link>https://pyemma.github.io//Reinforcment-Learning-Lesson-6/</link>
        <guid isPermaLink="true">https://pyemma.github.io//Reinforcment-Learning-Lesson-6/</guid>
      </item>
    
  </channel>
</rss>
