<!doctype html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.4.1" /><meta property="og:title" content="How to Design Webhook" /><meta name="author" content="Coding Monkey" /><meta property="og:locale" content="en" /><meta name="description" content="Today, let’s discuss about how to design a system that could let customer to register webhook and send webhook requests to destination." /><meta property="og:description" content="Today, let’s discuss about how to design a system that could let customer to register webhook and send webhook requests to destination." /><link rel="canonical" href="https://pyemma.github.io/How-to-Design-Webhook/" /><meta property="og:url" content="https://pyemma.github.io/How-to-Design-Webhook/" /><meta property="og:site_name" content="Coding Monkey" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2023-12-03T00:00:00-08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="How to Design Webhook" /><meta name="twitter:site" content="@" /><meta name="twitter:creator" content="@pyemma" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Coding Monkey","url":"https://github.com/pyemma"},"dateModified":"2024-10-13T23:27:03-07:00","datePublished":"2023-12-03T00:00:00-08:00","description":"Today, let’s discuss about how to design a system that could let customer to register webhook and send webhook requests to destination.","headline":"How to Design Webhook","mainEntityOfPage":{"@type":"WebPage","@id":"https://pyemma.github.io/How-to-Design-Webhook/"},"url":"https://pyemma.github.io/How-to-Design-Webhook/"}</script><title>How to Design Webhook | Coding Monkey</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Coding Monkey"><meta name="application-name" content="Coding Monkey"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.6.0/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.29.0/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox@3.3.0/dist/css/glightbox.min.css"> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return 'mode'; } static get MODE_ATTR() { return 'data-mode'; } static get DARK_MODE() { return 'dark'; } static get LIGHT_MODE() { return 'light'; } static get ID() { return 'mode-toggle'; } constructor() { let self = this;this.sysDarkPrefers.addEventListener('change', () => { if (self.hasMode) { self.clearMode(); } self.notify(); }); if (!this.hasMode) { return; } if (this.isDarkMode) { this.setDark(); } else { this.setLight(); } } get sysDarkPrefers() { return window.matchMedia('(prefers-color-scheme: dark)'); } get isPreferDark() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); }get modeStatus() { if (this.hasMode) { return this.mode; } else { return this.isPreferDark ? ModeToggle.DARK_MODE : ModeToggle.LIGHT_MODE; } } setDark() { document.documentElement.setAttribute(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { document.documentElement.setAttribute(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { document.documentElement.removeAttribute(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); }notify() { window.postMessage( { direction: ModeToggle.ID, message: this.modeStatus }, '*' ); } flipMode() { if (this.hasMode) { this.clearMode(); } else { if (this.isPreferDark) { this.setLight(); } else { this.setDark(); } } this.notify(); } } const modeToggle = new ModeToggle(); </script><body><aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end"><header class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"><img src="/assets/profile.png" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a><h1 class="site-title"> <a href="/">Coding Monkey</a></h1><p class="site-subtitle fst-italic mb-0">I’m a staff software engineer with rich experience in recommendation system and machine learning infrastructure. I spent my last 8 years in both Big-Tech (Meta & LinkedIn) and startups (Aven), and I’m glad to see if my past experience and learnings could help boost your career growth <br><br> <a href="https://bit.ly/41vi77B"><strong>book a session now</strong></a></p></header><nav class="flex-column flex-grow-1 w-100 ps-0"><ul class="nav"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>ABOUT</span> </a></ul></nav><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <button type="button" class="btn btn-link nav-link" aria-label="Switch Mode" id="mode-toggle"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/pyemma" aria-label="github" target="_blank" rel="noopener noreferrer" > <i class="fab fa-github"></i> </a> <a href="https://twitter.com/" aria-label="twitter" target="_blank" rel="noopener noreferrer" > <i class="fa-brands fa-x-twitter"></i> </a> <a href="javascript:location.href = 'mailto:' + ['pyemma1991','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></aside><div id="main-wrapper" class="d-flex justify-content-center"><div class="container d-flex flex-column px-xxl-5"><header id="topbar-wrapper" aria-label="Top Bar"><div id="topbar" class="d-flex align-items-center justify-content-between px-lg-3 h-100" ><nav id="breadcrumb" aria-label="Breadcrumb"> <span> <a href="/">Home</a> </span> <span>How to Design Webhook</span></nav><button type="button" id="sidebar-trigger" class="btn btn-link"> <i class="fas fa-bars fa-fw"></i> </button><div id="topbar-title"> Post</div><button type="button" id="search-trigger" class="btn btn-link"> <i class="fas fa-search fa-fw"></i> </button> <search id="search" class="align-items-center ms-3 ms-lg-0"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </search> <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button></div></header><div class="row flex-grow-1"><main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4"><article class="px-1"><header><h1 data-toc-skip>How to Design Webhook</h1><div class="post-meta text-muted"> <span> Posted <time data-ts="1701590400" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Dec 3, 2023 </time> </span> <span> Updated <time data-ts="1728887223" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Oct 13, 2024 </time> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://github.com/pyemma">Coding Monkey</a> </em> </span><div> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="2610 words" > <em>14 min</em> read</span></div></div><div style="text-align: right;"> <span> <a href="https://hitscounter.dev/api/hit?url=https%3A%2F%2Fpyemma.github.io%2F&label=&icon=github&color=%23198754&message=&style=flat&tz=UTC" class="popup img-link shimmer"><img src="https://hitscounter.dev/api/hit?url=https%3A%2F%2Fpyemma.github.io%2F&label=&icon=github&color=%23198754&message=&style=flat&tz=UTC" alt="Views" loading="lazy"></a> </span></div></div></header><div class="content"><p>Today, let’s discuss about how to design a system that could let customer to register webhook and send webhook requests to destination.</p><p>Let’s first align on some terms that we are going to use across this post:</p><ul><li><em>webhook provider</em>: the platform that let customer to register webhook and send the webhook request<li><em>webhook customer</em>: they provide the endpoint they would like the provider to send the webhook request to</ul><h2 id="what-is-webhook"><span class="me-2">What is Webhook</span><a href="#what-is-webhook" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>For readers that are not familiar with Webhook, it is a type of <strong>notification mechanism</strong> that communicates in one direction. This is a technique widely used in SaaS platform (e.g. Shopify, Strip, Slack) for external applications to receive data when some events they interested in happened on these platform.</p><p>For example, <em>codingmonkey.com</em> is a website that I’m running (hosted on AWS maybe), and I have a shop on Shopify that sells awesome keyboards. I could register a Webhook on Shopify so that whenever there are some Shopify users purchase awesome keyboards, a purchase event would be sent to an endpoint that is hosting on my server to process (e.g. store it in database, issue an invoice to purchaser, or send a thank you email).</p><p>Sounds similar? Yeah, it sounds pretty like a <em>notification system</em>. The difference here is that customer need to register webhook to express which event they would like to listen to and which endpoint URL the data need to be send to. There are also some other difference, such as we need to know if the webhook request is successfully received by <em>codingmonkey.com</em> or not, and additional security check to protect the data we are sending. Excited to learn more? Let’s dive deep and see how we could build such a system.</p><h2 id="functional-requirement"><span class="me-2">Functional Requirement</span><a href="#functional-requirement" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>I didn’t find very crystal requirements on this, the following is some FR I summarized from the industrial examples</p><ul><li>Customer could register webhook and they could register multiple webhook<li>Support retry of webhook and minimize lost webhook as much as possible<li>Provide observability to customers</ul><h2 id="non-functional-requirements"><span class="me-2">Non Functional Requirements</span><a href="#non-functional-requirements" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ul><li>1B events pre day, which is equivalent to 10k qps for webhook trigger and request sending<li>High availability<li>The design should scale<li>Security</ul><h2 id="some-questions-to-clarify"><span class="me-2">Some questions to clarify</span><a href="#some-questions-to-clarify" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ul><li>Do we allow event loss?<ul><li>No, we should avoid event loss as much as possible.</ul><li>What delivery semantic do we provide? At least once, at most once or exactly once?<ul><li>At least once</ul><li>If we resend webhook, could we resume the endpoint to be idempotent?<ul><li>Yes, but we need to provide necessary info to achieve that</ul></ul><h2 id="high-level-design"><span class="me-2">High Level Design</span><a href="#high-level-design" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>I would skip the API design and the back envelop estimation for the sake of sanction of this post. We would start simple to first meet the functional requirements, and then improve the availability, scalability of our system.</p><h3 id="webhook-registration"><span class="me-2">Webhook Registration</span><a href="#webhook-registration" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>We need to be able to let user to register webhook in our system. Below is a simple design of this part</p><p><a href="/assets/webhook_registeration.png" class="popup img-link shimmer"><img src="/assets/webhook_registeration.png" alt="Webhook Registration Flow" loading="lazy"></a></p><p>The design is pretty simple, which we have web server to handle request from client and store the information in the <strong>webhook metadata database</strong>. This metadata database is going to be used by the webhook delivery flow to figure out where to send the webhook request to.</p><p>For each webhook, we would generate a unique <code class="language-plaintext highlighter-rouge">webhook_id</code> as the unique identifier of each webhook. Besides that, we also need to store the <code class="language-plaintext highlighter-rouge">event_type</code> that this webhook listen to, as well as the <code class="language-plaintext highlighter-rouge">owner_id</code>. The <code class="language-plaintext highlighter-rouge">event_type</code> is a list of per-defined events that are available on our platform, which could be revealed via API document provided to customer. Besides that, we also need to store the <code class="language-plaintext highlighter-rouge">url</code> and <code class="language-plaintext highlighter-rouge">secret_token</code> in the database, to know where we should send the request to, as well as sending the request safely. The <code class="language-plaintext highlighter-rouge">secret_token</code> could be used for authentication and encryption for sending the webhook requests. In this schema, customers could register multiple webhook within the system.</p><p>One challenge here is that how to verify that customers have ownership on the urls they have provided. One common solution here is to send a test event to the endpoint they are providing, and ask them to verify they have received it; or by including a “challenge” in the request that the endpoints need to echo back (e.g. <a href="https://www.dropbox.com/developers/reference/webhooks#documentation">Dropbox webhook</a>).</p><h3 id="webhook-delivery"><span class="me-2">Webhook Delivery</span><a href="#webhook-delivery" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Next, let’s take a look at the webhook request deliver flow, which is the meaty part of the entire system. As mentioned earlier, the entire system is similar to notification system, and thus I use notification system as a template for this design. Below is a high level design of this flow</p><p><a href="/assets/webhook_delivery.png" class="popup img-link shimmer"><img src="/assets/webhook_delivery.png" alt="Webhook Delivery" loading="lazy"></a></p><p>In this design, we adopted a <em>single responsibility strategy</em> and separate the delivery logic into several components</p><ul><li><strong>Webhook Controller</strong> is responsible for processing the events (that are generated on our platform) and figuring out which endpoint we should send the data, as well as constructing the payload of the request. Here we assume that the events generated from our platform contains the <code class="language-plaintext highlighter-rouge">event_type</code> and <code class="language-plaintext highlighter-rouge">owner_id</code> information (because we don’t want the event that happened in our shop to be delivered to others’ endpoints). With <code class="language-plaintext highlighter-rouge">event_type</code> and <code class="language-plaintext highlighter-rouge">owner_id</code>, controller could retrieve the record from the <strong>metadata database</strong> and construct a webhook request task. Once the task is constructed, controller would write an entry into <strong>Webhook Delivery Log</strong> database to persistent this information, and set the <code class="language-plaintext highlighter-rouge">request_status</code> to <code class="language-plaintext highlighter-rouge">PENDING</code>, which we could leverage later for different retry strategy.<li><strong>Message Queue</strong> is adopted to store the webhook request task, which worker would consume. Using message queue bring the following benefits, which outperform the additional complexity they bring:<ul><li>controller don’t need to wait for the current webhook request to be delivered to process the next one (it is async okay). This not only saves resource, but also increases robustness (e.g. if worker failed, controller could still make progress and put job onto the queue instead of being blocked).<li>if there is a burst of events come in, message queue could help buffer the increased volume of task so that worker won’t be throttling.</ul><li><strong>Webhook Worker</strong> is responsible for consume webhook request task from the queue, and send the actual HTTP POST request to the endpoint. The payload of the HTTP POST request could be something like this</ul><div class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="JSON"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="p">{</span><span class="w">
    </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="err">str</span><span class="w">
    </span><span class="nl">"event_type"</span><span class="p">:</span><span class="w"> </span><span class="err">str</span><span class="w">
    </span><span class="nl">"created"</span><span class="p">:</span><span class="w"> </span><span class="err">int</span><span class="p">,</span><span class="w">
    </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"field_1"</span><span class="p">:</span><span class="w"> </span><span class="err">value_</span><span class="mi">1</span><span class="p">,</span><span class="w">
        </span><span class="nl">"field_2"</span><span class="p">:</span><span class="w"> </span><span class="err">value_</span><span class="mi">2</span><span class="p">,</span><span class="w">
        </span><span class="err">...</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><p>Worker would need to wait for the response from the endpoints, to know if the request has been successfully received. If received, then worker could update the record’s <code class="language-plaintext highlighter-rouge">request_status</code> in the <em>Webhook Delivery Log</em> database to <code class="language-plaintext highlighter-rouge">SUCCEED</code>; otherwise, different strategy of retry could be adopted to resent the webhook request. Supporting retry also means that we are providing <strong>at least once</strong> semantic, which could result in duplicated request sent to endpoints. We expect these endpoints need to be idempotent, which is doable with the <code class="language-plaintext highlighter-rouge">id</code> sent along with the HTTP POST request.</p><h3 id="webhook-retry-strategy"><span class="me-2">Webhook Retry Strategy</span><a href="#webhook-retry-strategy" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>One critical consideration for webhook system is the retry mechanism in case HTTP POST returns 4xx or 5xx code, or timeout. There are different retry strategies:</p><ol><li>Retry immediately upon failure within a time range repeatedly, or until max retry limit<li>Exponential backoff within a time range (e.g. 24hrs), or until max retry limit</ol><p>For example, <a href="https://stripe.com/docs/webhooks#retries">Strip</a> would attempts to delivery webhook up to 3 days with an exponential backoff. <em>Option 1</em> is easy to implement, but the issue is that: if endpoint is returning error code, then it might take some time to mitigate the issue; immediate retry is likely to hit the same error, try again later time would be a better option.</p><p>In order to achieve exponential backoff retry mechanism, we would use a cron version <strong>Webhook Controller</strong>, which dose not consume the events from upstream, but scan the <strong>Webhook Delivery Log</strong> database to identify the webhook requests that are still in <code class="language-plaintext highlighter-rouge">PENDING</code> status and have not exceed the max retry. For each of such request, the controller would bump their <code class="language-plaintext highlighter-rouge">retry_count</code> or <code class="language-plaintext highlighter-rouge">retry_timestamp</code>, and publish a new task into message queue.</p><p>The addition of this cron version <strong>Webhook Controller</strong> could also help mitigate worker failure issue. For example, if one webhook http request is consumed and removed from the message queue by a worker, but suddenly the worker failed; since the task is already removed from the queue, other worker won’t able to get it and process it again. However, the cron controller would notice in from the log that there is one <code class="language-plaintext highlighter-rouge">PENDING</code> request and schedule it to retry.</p><blockquote><p>Another option is that if message queue provide the capability to persistent messages, worker could commit the position of the message in the queue they have processed, and if worker failed, it could resume from its last committed position and process the message again</p></blockquote><p>If for some endpoints, the failure is consistent for a certain time and over the threshold, we could temporarily mark the endpoints as <code class="language-plaintext highlighter-rouge">disabled</code> in the metadata’s <code class="language-plaintext highlighter-rouge">status</code> field to prevent new events from further deliver to them. And we could send alert email to customers to have them investigate into the issue. Once the issue is mitigated, the <code class="language-plaintext highlighter-rouge">status</code> could be changed back, and we could consumer the delivery log to resume the webhook request; or use other channel, such as dump the entire data that need to be delivered during this time and send it over to customer.</p><h3 id="observability"><span class="me-2">Observability</span><a href="#observability" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Since we have already log the status of each webhook request in <strong>Webhook Delivery Log</strong> database, it is easy to support the observability. This could be implemented via having web application server to send a query to the database to aggregate the data and render it as a dashboard for customers. They could know how many webhook request have been sent, what’s the failure rate, etc.</p><h3 id="security"><span class="me-2">Security</span><a href="#security" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Security is especially important in webhook system. In <a href="#webhook-registration">webhook registration</a> section, we authenticate that the endpoints belongs to users, we also need to authenticate ourself that the HTTP request is from us.</p><p>One common approach is to use <a href="https://en.wikipedia.org/wiki/HMAC">HMAC</a> to sign the request with a shared secret with the user and sent the signature along with the request(e.g. Strip uses <a href="https://stripe.com/docs/webhooks#verify-events">this approach</a>) and user could verify the signature with the shared secret. This shared secret could be auto generated upon user register webhook in our system, and show them to user in their monitor dashboard. This approach could also help us prevent replay attack, by including a timestamp used to expire webhook request.</p><p>Another approach, which is less common, is to get a token from the consumer and add it to the <code class="language-plaintext highlighter-rouge">Authorization</code> header for validation. For example, if the owner of the endpoint has authorization server, then before sending webhook request, we could first obtain a <a href="https://jwt.io/introduction">JWT token</a> and store it within our metadata table <code class="language-plaintext highlighter-rouge">secret_token</code> and use it each time we need to send webhook request.</p><p>Besides the authentication problem, we also need to prevent the data we are sending could be read by others. There are also several options with different trade off:</p><ul><li>Avoid send sensitive information in the webhook payload. Instead, we could only send some entity id which is totally meaningless and ask customer to pull data again via other API. Pros is that this is the most safe approach, and the cons is that customer experience is worst<li>Another option is to encrypt the data with a shared secret key, which is only known between webhook provider and webhook consumer. A follow up of this question is how could we share this secret key safely between customer and provider over the unsafe network? Here we could use RSA encryption. (This is a general practice, RSA is safe, since only yourself know the private key; but the amount of data could be transferred via RSA is limited. So it makes since to use RSA to send another secret key, which is used for encryption/decryption of large volume of data)<li>Sending data with HTTPS and certificate pinning is also an option to safely transfer sensitive data, but this would have some performance hurt and require customer to have HTTPS setup such as CA</ul><h3 id="high-availability"><span class="me-2">High Availability</span><a href="#high-availability" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Let’s see if there is any single point of failure in our current design. What comes to us first is the database and message queue. There are multiple replication strategy here we could use, each comes with different trade off:</p><ul><li>For <strong>Webhook Metadata Database</strong>, we could adopt single leader strategy, and have 2 followers. The followers could use synchronized replication, which provides good consistency, but the write throughput on the leader would be low; while if we use async approach, leader could handle more write request while could lead to consistency issues among leader and followers. If we are building for a geo webhook system, we might also consider multi-leader strategy, with better write request severing based on location and annoy of write conflict.<li>For <strong>Webhook Delivery Log Database</strong>, besides the aforementioned strategy, we could also consider the quorum based replication, which provides the best write throughput and eventual consistency is acceptable in this case. (Q: what would be the worst case here).<li>For <strong>Message Queue</strong>, similar to the database, we could also have replica setup so that the message is written to multiple node instead of single one. Also, even if we only have a single node queue and it failed. Since we are storing all scheduled webhook request in the <strong>Webhook Delivery Log Database</strong>, the <strong>webhook controller (corn)</strong> would identify the abnormal ones and try to reschedule them.</ul><p>For other components such as <strong>web app server</strong>, <strong>webhook controller</strong> and <strong>webhook worker</strong>, they could be stateless. If a node fails, there would be other nodes available to continue the work.</p><h3 id="scalability"><span class="me-2">Scalability</span><a href="#scalability" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>For scalability, we could horizontally scale <strong>web app server</strong>, <strong>webhook controller</strong> and <strong>webhook worker</strong> by adding more nodes into the cluster. For database, we could shard it to scale if the total volume of data is too large to fit onto a single machine. Message queue could also be horizontally sharded by increase the number of partitions.</p><p>There could be hotspot. For example, my awesome keyboard is so popular that lots of customer is visiting my shop and vast amount of events are triggered. To handle the hotspot, we could use a dynamic config to redirect the traffic of hotspot to specific cluster of machines, instead of starving the quote with other customers; or we could further shard the hotspot by some approach such suffix with numbers.</p><h3 id="other-optimization"><span class="me-2">Other optimization</span><a href="#other-optimization" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>There are couple of other optimizations we could add to our system to make it more robust</p><ul><li>we could have load balances in front of webhook controller to route based on machine utilization; also we could integrate the rate limit here to prevent abuse of the system (such as bot triggered events)<li>we could add a layer of cache to reduce the amount of read to metadata<li>we could add a rate limiter to help control the http request we send to customers; for some customers that have high security requirement, they might only trust http request sent from specific IPs, we could have dedicated VPC to support that needs<li>for observability, we could add some pre-compute mechanism to reduce the volume of data that the query need to scan; for example T-1 snapshot + on demand query on T</ul><p>Here is our final design <a href="/assets/webhook-final.png" class="popup img-link shimmer"><img src="/assets/webhook-final.png" alt="Final Design" loading="lazy"></a></p><blockquote class="prompt-tip"><p>If you find this post helpful, feel free to scan the QR code below to support me and treat me to a cup of coffee</p></blockquote><p><a href="/assets/qr%20code.png" class="popup img-link shimmer"><img src="/assets/qr%20code.png" alt="Thank You" width="300" height="300" loading="lazy"></a></p><h3 id="reference"><span class="me-2">Reference</span><a href="#reference" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ol><li><a href="https://workos.com/blog/building-webhooks-into-your-application-guidelines-and-best-practices">Building Webhooks Into Your Application: Guidelines and Best Practices</a><li><a href="https://stripe.com/docs/webhooks">Strip Webhook Doc</a><li><a href="https://www.dropbox.com/developers/reference/webhooks#documentation">Dropbox Webhook Doc</a><li><a href="https://shopify.dev/docs/apps/webhooks/best-practices">Shopify Webhook Best Practices</a><li><a href="https://zapier.com/engineering/webhook-design/">Add Webhooks to Your API the Right Way</a><li><a href="https://icyfenix.cn/architect-perspective/general-architecture/system-security/confidentiality.html">Phoenix Architecture</a></ol></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href="/categories/distributed-system/">Distributed System</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/system-design/" class="post-tag no-text-decoration" >system design</a> <a href="/tags/webhook/" class="post-tag no-text-decoration" >webhook</a></div><div class=" post-tail-bottom d-flex justify-content-between align-items-center mt-5 pb-2 " ><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper d-flex align-items-center"> <span class="share-label text-muted">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=How%20to%20Design%20Webhook%20-%20Coding%20Monkey&url=https%3A%2F%2Fpyemma.github.io%2FHow-to-Design-Webhook%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter"> <i class="fa-fw fa-brands fa-square-x-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=How%20to%20Design%20Webhook%20-%20Coding%20Monkey&u=https%3A%2F%2Fpyemma.github.io%2FHow-to-Design-Webhook%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fpyemma.github.io%2FHow-to-Design-Webhook%2F&text=How%20to%20Design%20Webhook%20-%20Coding%20Monkey" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Telegram" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <button id="copy-link" aria-label="Copy link" class="btn small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!" > <i class="fa-fw fas fa-link pe-none fs-6"></i> </button> </span></div></div></div></article></main><aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 mb-5 text-muted"><div class="access"><section id="access-lastmod"><h2 class="panel-heading">Recently Updated</h2><ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/Book-PyTorch-Training-Optimization/">PyTorch 性能与显存优化手册</a><li class="text-truncate lh-lg"> <a href="/Long-User-Sequence-Modeling-In-Recsys/">Recommendation System - Long User Sequence Modeling</a><li class="text-truncate lh-lg"> <a href="/Machine-Learning-System-Design-Sparse-Features/">Trend of Sparse Features in Recommendation System</a><li class="text-truncate lh-lg"> <a href="/Recsys-Paper-Review-2025-Q1/">Recsys Paper Summary 2025 Q1</a><li class="text-truncate lh-lg"> <a href="/How-to-design-slack/">How to Design Slack</a></ul></section><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/machine-learning-design/">machine learning design</a> <a class="post-tag btn btn-outline-primary" href="/tags/system-design/">system design</a> <a class="post-tag btn btn-outline-primary" href="/tags/distributed-system/">distributed system</a> <a class="post-tag btn btn-outline-primary" href="/tags/embeddings/">embeddings</a> <a class="post-tag btn btn-outline-primary" href="/tags/llm/">llm</a> <a class="post-tag btn btn-outline-primary" href="/tags/message-queue/">message queue</a> <a class="post-tag btn btn-outline-primary" href="/tags/realtime-system/">realtime system</a> <a class="post-tag btn btn-outline-primary" href="/tags/recommendation-system/">recommendation-system</a> <a class="post-tag btn btn-outline-primary" href="/tags/sparse-features/">sparse features</a> <a class="post-tag btn btn-outline-primary" href="/tags/stateful-service/">stateful service</a></div></section></div><section id="toc-wrapper" class="d-none ps-0 pe-4"><h2 class="panel-heading ps-3 mb-2">Contents</h2><nav id="toc"></nav></section></aside></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4"><aside id="related-posts" aria-labelledby="related-label"><h3 class="mb-4" id="related-label">Further Reading</h3><nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><article class="col"> <a href="/Book-Pattern-of-Distributed-System/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1720162800" data-df="ll" > Jul 5, 2024 </time><h4 class="pt-0 my-2">读书笔记 - Patterns of Distributed System</h4><div class="text-muted"><p>最近读了一本和 distributed system 相关的书籍，介绍了在 distributed system 里面常用的一些 pattern. 这是一篇简要的读书笔记，把书中提到的几个 pattern 总结了下来; 我计划会经常更新这篇 blog, 把我新学习到的或者总结出来的一些 pattern 记录在这里; 希望能起到一个引导性的作用，给大家提供一个提纲挈领的思路 Patterns...</p></div></div></a></article><article class="col"> <a href="/How-to-design-auction-system/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1712386800" data-df="ll" > Apr 6, 2024 </time><h4 class="pt-0 my-2">How to Design Auction System</h4><div class="text-muted"><p>In this post, let’s discuss a little bit how to design an auction system similar to the one on eBay, where owner could list their items in the system and others could place a bid on it. User with h...</p></div></div></a></article><article class="col"> <a href="/DDIA-Stream-Processing-I/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1700553600" data-df="ll" > Nov 21, 2023 </time><h4 class="pt-0 my-2">DDIA Chapter 11 Stream Processing Part I</h4><div class="text-muted"><p>In this post, we would introduce stream processing. Since it is a large topic, we would break it down into 2 part, and in the first part, we would focus on the component that is related to the “flo...</p></div></div></a></article></nav></aside><nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation"> <a href="/DDIA-Stream-Processing-I/" class="btn btn-outline-primary" aria-label="Older" ><p>DDIA Chapter 11 Stream Processing Part I</p></a> <a href="/How-to-use-GPT-for-recommendation-task/" class="btn btn-outline-primary" aria-label="Newer" ><p>How to use LLM for recommendation task</p></a></nav><div id="disqus_thread"><p class="text-center text-muted small">Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script type="text/javascript"> var disqus_config = function () { this.page.url = 'https://pyemma.github.io/How-to-Design-Webhook/'; this.page.identifier = '/How-to-Design-Webhook/'; };var disqus_observer = new IntersectionObserver( function (entries) { if (entries[0].isIntersecting) { (function () { var d = document, s = d.createElement('script'); s.src = 'https://pyemma.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); disqus_observer.disconnect(); } }, { threshold: [0] } ); disqus_observer.observe(document.getElementById('disqus_thread'));function reloadDisqus() { if (event.source === window && event.data && event.data.direction === ModeToggle.ID) {if (typeof DISQUS === 'undefined') { return; } if (document.readyState == 'complete') { DISQUS.reset({ reload: true, config: disqus_config }); } } } if (document.getElementById('mode-toggle')) { window.addEventListener('message', reloadDisqus); } </script><footer aria-label="Site Info" class=" d-flex flex-column justify-content-center text-muted flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3 " ><p>© <time>2025</time> <a href="https://github.com/pyemma">Coding Monkey</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >Some rights reserved.</span></p><p>Using the <a data-bs-toggle="tooltip" data-bs-placement="top" title="v7.1.1" href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener" >Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>.</p></footer></div></div><div id="search-result-wrapper" class="d-flex justify-content-center d-none"><div class="col-11 content"><div id="search-hints"><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/machine-learning-design/">machine learning design</a> <a class="post-tag btn btn-outline-primary" href="/tags/system-design/">system design</a> <a class="post-tag btn btn-outline-primary" href="/tags/distributed-system/">distributed system</a> <a class="post-tag btn btn-outline-primary" href="/tags/embeddings/">embeddings</a> <a class="post-tag btn btn-outline-primary" href="/tags/llm/">llm</a> <a class="post-tag btn btn-outline-primary" href="/tags/message-queue/">message queue</a> <a class="post-tag btn btn-outline-primary" href="/tags/realtime-system/">realtime system</a> <a class="post-tag btn btn-outline-primary" href="/tags/recommendation-system/">recommendation-system</a> <a class="post-tag btn btn-outline-primary" href="/tags/sparse-features/">sparse features</a> <a class="post-tag btn btn-outline-primary" href="/tags/stateful-service/">stateful service</a></div></section></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><aside aria-label="Scroll to Top"> <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button></aside></div><div id="mask"></div><aside id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-animation="true" data-bs-autohide="false" ><div class="toast-header"> <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close" ></button></div><div class="toast-body text-center pt-0"><p class="px-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></aside><script src="https://cdn.jsdelivr.net/combine/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/glightbox@3.3.0/dist/js/glightbox.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.13/dayjs.min.js,npm/dayjs@1.11.13/locale/en.js,npm/dayjs@1.11.13/plugin/relativeTime.js,npm/dayjs@1.11.13/plugin/localizedFormat.js,npm/tocbot@4.29.0/dist/tocbot.min.js"></script> <script src="/assets/js/dist/post.min.js"></script> <script defer src="/app.min.js?baseurl=&register=true" ></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-M1GM2SJR6M"></script> <script> document.addEventListener('DOMContentLoaded', function (event) { window.dataLayer = window.dataLayer || []; function gtag() { dataLayer.push(arguments); } gtag('js', new Date()); gtag('config', 'G-M1GM2SJR6M'); }); </script> <script>SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<article class="px-1 px-sm-2 px-lg-4 px-xl-0"><header><h2><a href="{url}">{title}</a></h2><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div></header><p>{snippet}</p></article>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
